<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="è€ƒè©¦å ±æ™‚æé†’ç³»çµ± - å°ˆæ¥­çš„è€ƒè©¦æ™‚é–“ç®¡ç†å·¥å…·">
    <meta name="keywords" content="è€ƒè©¦, å ±æ™‚, æé†’, æ™‚é–“ç®¡ç†, å­¸æ ¡">
    <meta name="author" content="Examination Timing Alert System">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./images/favicon.png">
    
    <title>è€ƒè©¦å ±æ™‚æé†’ç³»çµ±</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- TailwindCSS Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E3A8A',
                        secondary: '#374151',
                        accent: '#D97706',
                        warning: '#D97706',
                        surface: '#F8FAFC',
                        'surface-dark': '#0F172A'
                    },
                    fontFamily: {
                        'mono': ['Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>
    
    <!-- Custom Styles -->
    <style>
        /* Animation Styles */
        .warning-flash {
            animation: flash 2s infinite;
        }
        
        @keyframes flash {
            0%, 50% { 
                background-color: #FEF3C7; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #F59E0B; 
                border-color: #92400E; 
            }
        }
        
        .dark .warning-flash {
            animation: flash-dark 2s infinite;
        }
        
        @keyframes flash-dark {
            0%, 50% { 
                background-color: #92400E; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #B45309; 
                border-color: #F59E0B; 
            }
        }
        
        .urgent-flash {
            animation: urgent 1s infinite;
        }
        
        @keyframes urgent {
            0%, 50% { 
                background-color: #FEF3C7; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #F59E0B; 
                border-color: #92400E; 
            }
        }
        
        .dark .urgent-flash {
            animation: urgent-dark 1s infinite;
        }
        
        @keyframes urgent-dark {
            0%, 50% { 
                background-color: #92400E; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #B45309; 
                border-color: #F59E0B; 
            }
        }
        
        /* Enhanced Visual Effects */
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .time-display {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            min-height: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .dark .time-display {
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
        }
        
        /* Time Input Display */
        .time-input-display {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .time-input-display:hover {
            background-color: #F1F5F9;
            border-color: #1E3A8A;
        }
        
        .dark .time-input-display:hover {
            background-color: #475569;
            border-color: #3B82F6;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
        }
        
        .dark .modal-content {
            background: #1e293b;
            border: 1px solid #475569;
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1) translateY(0);
        }
        
        /* Time Picker Styles */
        .time-picker {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            margin: 1.5rem 0;
        }
        
        .time-input {
            width: 80px;
            height: 60px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            font-family: monospace;
            font-weight: bold;
        }
        
        .dark .time-input {
            background: #374151;
            border-color: #6b7280;
            color: white;
        }
        
        .time-input:focus {
            outline: none;
            border-color: #1E3A8A;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .time-separator {
            font-size: 2rem;
            font-weight: bold;
            color: #64748b;
        }
        
        .dark .time-separator {
            color: #94a3b8;
        }
        
        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
            
            .dark .warning-flash,
            .dark .urgent-flash {
                background-color: #92400E !important;
            }
            
            .modal-overlay,
            .modal-content {
                transition: none;
            }
        }
        
        /* Print Styles */
        @media print {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .modal-overlay {
                display: none !important;
            }
        }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 640px) {
            .time-display {
                font-size: 3rem !important;
            }
            
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .time-picker {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .time-input {
                width: 100px;
                height: 50px;
                font-size: 1.25rem;
            }
        }
        
        /* Focus Indicators */
        input:focus,
        button:focus {
            outline: 2px solid #1E3A8A;
            outline-offset: 2px;
        }
        
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen font-sans">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-white px-4 py-2 rounded">
        è·³è‡³ä¸»è¦å…§å®¹
    </a>

    <!-- Header -->
    <header class="bg-primary dark:bg-slate-800 border-b-4 border-accent shadow-lg">
        <div class="container mx-auto p-6 max-w-7xl">
            <div class="flex items-center justify-center gap-6">
                <img 
                    src="./images/NDC_school_logov2.png" 
                    alt="å­¸æ ¡æ ¡å¾½" 
                    class="h-16 w-16 object-contain"
                    loading="eager"
                    onerror="this.style.display='none'"
                >
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-white tracking-wider">
                        è€ƒè©¦å ±æ™‚æé†’ç³»çµ±
                    </h1>
                    <p class="text-blue-100 dark:text-slate-300 mt-2 text-lg">
                        EXAMINATION TIMING ALERT SYSTEM
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-6 max-w-7xl">
        <!-- Top Three Panels -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Subject Selection Panel -->
            <section aria-labelledby="subject-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-green-600 text-white p-4 border-b-2 border-green-700 rounded-t-lg">
                        <h2 id="subject-title" class="text-xl font-bold text-center tracking-wide">
                            è€ƒè©¦ç§‘ç›®
                        </h2>
                        <p class="text-center text-green-100 text-sm mt-1">
                            EXAM SUBJECT
                        </p>
                    </header>
                    
                    <div class="p-4">
                        <!-- Subject Selection 1 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">è€ƒè©¦ç§‘ç›®1 EXAM SUBJECT 1</div>
                                <select 
                                    id="examSubject1" 
                                    class="w-full py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-100 transition-all rounded focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 text-sm font-medium"
                                    onchange="updateExamSubject(1)"
                                    aria-label="é¸æ“‡è€ƒè©¦ç§‘ç›®1"
                                >
                                    <option value="">è«‹é¸æ“‡è€ƒè©¦ç§‘ç›®1</option>
                                    <option value="ä¸­æ–‡ç§‘">ä¸­æ–‡ç§‘</option>
                                    <option value="è‹±æ–‡ç§‘">è‹±æ–‡ç§‘</option>
                                    <option value="æ•¸å­¸ç§‘">æ•¸å­¸ç§‘</option>
                                    <option value="å…¬æ°‘èˆ‡ç¤¾æœƒç™¼å±•ç§‘">å…¬æ°‘èˆ‡ç¤¾æœƒç™¼å±•ç§‘</option>
                                    <option value="ç”Ÿç‰©ç§‘">ç”Ÿç‰©ç§‘</option>
                                    <option value="åŒ–å­¸ç§‘">åŒ–å­¸ç§‘</option>
                                    <option value="ç‰©ç†ç§‘">ç‰©ç†ç§‘</option>
                                    <option value="è³‡è¨ŠåŠé€šè¨Šç§‘æŠ€ç§‘">è³‡è¨ŠåŠé€šè¨Šç§‘æŠ€ç§‘</option>
                                    <option value="ä¼æ¥­ã€æœƒè¨ˆèˆ‡è²¡å‹™æ¦‚è«–ç§‘">ä¼æ¥­ã€æœƒè¨ˆèˆ‡è²¡å‹™æ¦‚è«–ç§‘</option>
                                    <option value="ç¶“æ¿Ÿç§‘">ç¶“æ¿Ÿç§‘</option>
                                    <option value="åœ°ç†ç§‘">åœ°ç†ç§‘</option>
                                    <option value="ä¸­å²ç§‘">ä¸­å²ç§‘</option>
                                    <option value="æ­·å²ç§‘">æ­·å²ç§‘</option>
                                    <option value="è¦–è¦ºè—è¡“ç§‘">è¦–è¦ºè—è¡“ç§‘</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Subject Selection 2 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">è€ƒè©¦ç§‘ç›®2 EXAM SUBJECT 2</div>
                                <select 
                                    id="examSubject2" 
                                    class="w-full py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-100 transition-all rounded focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 text-sm font-medium"
                                    onchange="updateExamSubject(2)"
                                    aria-label="é¸æ“‡è€ƒè©¦ç§‘ç›®2"
                                >
                                    <option value="">è«‹é¸æ“‡è€ƒè©¦ç§‘ç›®2</option>
                                    <option value="ä¸­æ–‡ç§‘">ä¸­æ–‡ç§‘</option>
                                    <option value="è‹±æ–‡ç§‘">è‹±æ–‡ç§‘</option>
                                    <option value="æ•¸å­¸ç§‘">æ•¸å­¸ç§‘</option>
                                    <option value="å…¬æ°‘èˆ‡ç¤¾æœƒç™¼å±•ç§‘">å…¬æ°‘èˆ‡ç¤¾æœƒç™¼å±•ç§‘</option>
                                    <option value="ç”Ÿç‰©ç§‘">ç”Ÿç‰©ç§‘</option>
                                    <option value="åŒ–å­¸ç§‘">åŒ–å­¸ç§‘</option>
                                    <option value="ç‰©ç†ç§‘">ç‰©ç†ç§‘</option>
                                    <option value="è³‡è¨ŠåŠé€šè¨Šç§‘æŠ€ç§‘">è³‡è¨ŠåŠé€šè¨Šç§‘æŠ€ç§‘</option>
                                    <option value="ä¼æ¥­ã€æœƒè¨ˆèˆ‡è²¡å‹™æ¦‚è«–ç§‘">ä¼æ¥­ã€æœƒè¨ˆèˆ‡è²¡å‹™æ¦‚è«–ç§‘</option>
                                    <option value="ç¶“æ¿Ÿç§‘">ç¶“æ¿Ÿç§‘</option>
                                    <option value="åœ°ç†ç§‘">åœ°ç†ç§‘</option>
                                    <option value="ä¸­å²ç§‘">ä¸­å²ç§‘</option>
                                    <option value="æ­·å²ç§‘">æ­·å²ç§‘</option>
                                    <option value="è¦–è¦ºè—è¡“ç§‘">è¦–è¦ºè—è¡“ç§‘</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Time Configuration Panel -->
            <section aria-labelledby="config-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-green-600 text-white p-4 border-b-2 border-green-700 rounded-t-lg">
                        <h2 id="config-title" class="text-xl font-bold text-center tracking-wide">
                            è€ƒè©¦æ™‚é–“è¨­å®š
                        </h2>
                        <p class="text-center text-green-100 text-sm mt-1">
                            EXAM TIME CONFIGURATION
                        </p>
                    </header>
                    
                    <div class="p-4">
                        <!-- Time Configuration 1 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">è€ƒè©¦ç§‘ç›®1çµæŸæ™‚é–“ SUBJECT 1 END TIME</div>
                                <div id="subject1EndDisplay" 
                                     class="py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display" 
                                     onclick="TimePickerModal.open('subject1End')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="è¨­å®šè€ƒè©¦ç§‘ç›®1çµæŸæ™‚é–“">
                                    <div class="text-sm font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Time Configuration 2 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">è€ƒè©¦ç§‘ç›®2çµæŸæ™‚é–“ SUBJECT 2 END TIME</div>
                                <div id="subject2EndDisplay" 
                                     class="py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display" 
                                     onclick="TimePickerModal.open('subject2End')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="è¨­å®šè€ƒè©¦ç§‘ç›®2çµæŸæ™‚é–“">
                                    <div class="text-sm font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Time Display Panel -->
            <section aria-labelledby="remaining-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-green-600 text-white p-4 border-b-2 border-green-700 rounded-t-lg">
                        <h2 id="remaining-title" class="text-xl font-bold text-center tracking-wide">
                            å‰©é¤˜æ™‚é–“
                        </h2>
                        <p class="text-center text-green-100 text-sm mt-1">
                            REMAINING TIME
                        </p>
                    </header>
                    
                    <div class="p-4">
                        <!-- Remaining Time Display 1 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">è€ƒè©¦ç§‘ç›®1å‰©é¤˜æ™‚é–“ SUBJECT 1 REMAINING</div>
                                <div id="subject1Session" class="py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="subject1SessionTime" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Remaining Time Display 2 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">è€ƒè©¦ç§‘ç›®2å‰©é¤˜æ™‚é–“ SUBJECT 2 REMAINING</div>
                                <div id="subject2Session" class="py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="subject2SessionTime" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
        
        <!-- Hong Kong Time Panel (Below the three panels) -->
        <div class="mb-8">
            <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                <header class="bg-primary text-white p-4 border-b-2 border-blue-800 rounded-t-lg">
                    <h2 class="text-xl font-bold text-center tracking-wide">é¦™æ¸¯æ¨™æº–æ™‚é–“</h2>
                    <p class="text-center text-blue-100 text-sm mt-1">HONG KONG STANDARD TIME</p>
                </header>
                <div class="p-8 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 rounded-b-lg">
                    <div class="text-center">
                        <time 
                            id="currentTime" 
                            class="text-6xl xl:text-7xl font-bold font-mono text-primary dark:text-blue-300 time-display tracking-wider mb-4 block"
                            role="timer"
                            aria-live="polite"
                        ></time>
                        <div id="currentDate" class="text-lg text-slate-600 dark:text-slate-400 font-medium"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Buttons Section -->
        <div class="mt-8 text-center space-y-4">
            <!-- Audio Test Button -->
            <div>
                <button 
                    onclick="testAudioSystem()" 
                    class="bg-accent hover:bg-yellow-600 text-white py-3 px-8 font-semibold tracking-wide uppercase transition-colors border-2 border-accent hover:border-yellow-600 rounded-lg shadow-lg hover:shadow-xl focus:ring-2 focus:ring-offset-2 focus:ring-accent mr-4"
                    aria-describedby="audio-test-desc"
                >
                    ğŸµ æ¸¬è©¦éŸ³æ•ˆç³»çµ± TEST AUDIO
                </button>
                <span id="audio-test-desc" class="sr-only">æ¸¬è©¦éŸ³æ•ˆæ’­æ”¾åŠŸèƒ½</span>
                
                <!-- Audio Status Indicator -->
                <div id="audioStatus" class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                    <span id="audioStatusText">éŸ³æ•ˆç³»çµ±ï¼šæœªåˆå§‹åŒ–</span>
                </div>
            </div>
            
            <!-- Reset Button -->
            <div>
                <button 
                    onclick="resetAllTimes()" 
                    class="bg-secondary hover:bg-slate-600 text-white py-3 px-8 font-semibold tracking-wide uppercase transition-colors border-2 border-secondary hover:border-slate-600 rounded-lg shadow-lg hover:shadow-xl focus:ring-2 focus:ring-offset-2 focus:ring-secondary"
                    aria-describedby="reset-desc"
                >
                    é‡ç½®æ‰€æœ‰è¨­å®š RESET ALL
                </button>
                <span id="reset-desc" class="sr-only">æ¸…é™¤æ‰€æœ‰æ™‚é–“è¨­å®š</span>
            </div>
        </div>
    </main>

    <!-- Time Picker Modal -->
    <div id="timePickerModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-center mb-4 text-slate-900 dark:text-slate-100">è¨­å®šè€ƒè©¦çµæŸæ™‚é–“</h3>
            
            <div class="time-picker">
                <div>
                    <label for="hourInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center">å°æ™‚</label>
                    <input type="number" id="hourInput" class="time-input" min="0" max="23" placeholder="HH">
                </div>
                
                <div class="time-separator">:</div>
                
                <div>
                    <label for="minuteInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center">åˆ†é˜</label>
                    <input type="number" id="minuteInput" class="time-input" min="0" max="59" placeholder="MM">
                </div>
            </div>
            
            <div class="flex gap-3 justify-center mt-6">
                <button onclick="TimePickerModal.save()" class="bg-primary hover:bg-blue-800 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    ç¢ºå®š
                </button>
                <button onclick="TimePickerModal.clear()" class="bg-warning hover:bg-yellow-600 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-warning">
                    æ¸…é™¤
                </button>
                <button onclick="TimePickerModal.close()" class="bg-slate-500 hover:bg-slate-600 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden input fields for backwards compatibility -->
    <div style="display: none;">
        <input type="time" id="subject1End">
        <input type="time" id="subject2End">
    </div>

    <!-- JavaScript Application -->
    <script>
        'use strict';
        
        // Application State
        const AppState = {
            alertHistory: new Set(),
            timeAlertHistory: new Set(),
            isPlayingAudio: false,
            timers: new Map(),
            examTimes: {
                subject1End: '',
                subject2End: ''
            },
            examSubject1: '',
            examSubject2: ''
        };

        // Time Picker Modal
        const TimePickerModal = {
            currentField: null,
            
            open(fieldId) {
                this.currentField = fieldId;
                const modal = document.getElementById('timePickerModal');
                const hourInput = document.getElementById('hourInput');
                const minuteInput = document.getElementById('minuteInput');
                
                // Get current time value
                const currentTime = AppState.examTimes[fieldId];
                if (currentTime) {
                    const [hours, minutes] = currentTime.split(':');
                    hourInput.value = parseInt(hours).toString();
                    minuteInput.value = parseInt(minutes).toString();
                } else {
                    hourInput.value = '';
                    minuteInput.value = '';
                }
                
                modal.classList.add('show');
                
                // Focus first input
                setTimeout(() => {
                    hourInput.focus();
                }, 100);
                
                // Add keyboard listeners
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
            },
            
            close() {
                const modal = document.getElementById('timePickerModal');
                modal.classList.remove('show');
                this.currentField = null;
                
                // Remove keyboard listeners
                document.removeEventListener('keydown', this.handleKeyDown.bind(this));
            },
            
            async save() {
                const hourInput = document.getElementById('hourInput');
                const minuteInput = document.getElementById('minuteInput');
                
                let hours = parseInt(hourInput.value) || 0;
                let minutes = parseInt(minuteInput.value) || 0;
                
                // Validate input
                if (hours < 0 || hours > 23) {
                    this.showValidationMessage('å°æ™‚å¿…é ˆåœ¨ 0-23 ä¹‹é–“');
                    hourInput.focus();
                    return;
                }
                
                if (minutes < 0 || minutes > 59) {
                    this.showValidationMessage('åˆ†é˜å¿…é ˆåœ¨ 0-59 ä¹‹é–“');
                    minuteInput.focus();
                    return;
                }
                
                // Format time
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                

                
                // Update state and display
                AppState.examTimes[this.currentField] = timeString;
                
                // å®‰å…¨åœ°è¨­ç½®éš±è—inputçš„å€¼
                const hiddenInput = document.getElementById(this.currentField);
                if (hiddenInput) {
                    hiddenInput.value = timeString;
                }
                
                this.updateDisplay(this.currentField);
                
                // Clear alert histories when time is changed
                AppState.alertHistory.clear();
                AppState.timeAlertHistory.clear();
                

                
                this.close();
                
                // Update main display
                DisplayManager.updateDisplay();
            },
            
            clear() {
                AppState.examTimes[this.currentField] = '';
                
                // å®‰å…¨åœ°æ¸…é™¤éš±è—inputçš„å€¼
                const hiddenInput = document.getElementById(this.currentField);
                if (hiddenInput) {
                    hiddenInput.value = '';
                }
                
                this.updateDisplay(this.currentField);
                
                // Clear alert histories
                AppState.alertHistory.clear();
                AppState.timeAlertHistory.clear();
                
                this.close();
                
                // Update main display
                DisplayManager.updateDisplay();
            },
            
            updateDisplay(fieldId) {
                const displayElement = document.getElementById(fieldId + 'Display');
                if (!displayElement) {
                    console.warn(`é¡¯ç¤ºå…ƒç´ ä¸å­˜åœ¨: ${fieldId}Display`);
                    return;
                }
                
                const timeDiv = displayElement.querySelector('.time-display');
                if (!timeDiv) {
                    console.warn(`æ™‚é–“é¡¯ç¤ºå…ƒç´ ä¸å­˜åœ¨: .time-display in ${fieldId}Display`);
                    return;
                }
                
                const timeValue = AppState.examTimes[fieldId];
                
                if (timeValue) {
                    timeDiv.textContent = timeValue;
                } else {
                    timeDiv.textContent = '--:--';
                }
            },
            
            showValidationMessage(message) {
                // Create custom validation message
                const modal = document.querySelector('.modal-content');
                
                // Remove existing validation message
                const existingMessage = modal.querySelector('.validation-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Create new validation message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'validation-message bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded mb-4';
                messageDiv.textContent = message;
                
                // Insert before time picker
                const timePicker = modal.querySelector('.time-picker');
                modal.insertBefore(messageDiv, timePicker);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 3000);
            },
            
            handleKeyDown(event) {
                if (event.key === 'Escape') {
                    this.close();
                } else if (event.key === 'Enter') {
                    this.save();
                }
            }
        };

        // Utility Functions
        const Utils = {
            formatTime(date) {
                return date.toLocaleTimeString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            formatDate(date) {
                return date.toLocaleDateString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            },

            getHongKongTime() {
                return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Dark Mode Manager
        const DarkMode = {
            init() {
                // Initial check
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                
                // Listen for changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
        };

        // Time Calculator
        const TimeCalculator = {
            calculateTimeRemaining(endTime) {
                if (!endTime) return null;
                
                const now = Utils.getHongKongTime();
                const [hours, minutes] = endTime.split(':');
                const examEnd = new Date(now);
                examEnd.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (examEnd < now) {
                    examEnd.setDate(examEnd.getDate() + 1);
                }
                
                const diff = examEnd - now;
                
                if (diff <= 0) {
                    console.log(`â° è€ƒè©¦æ™‚é–“å·²åˆ°: endTime=${endTime}, diff=${diff}ms`);
                    return { ended: true, text: 'è€ƒè©¦å·²çµæŸ' };
                }
                
                const totalSeconds = Math.floor(diff / 1000);
                const hours_remaining = Math.floor(totalSeconds / 3600);
                const minutes_remaining = Math.floor((totalSeconds % 3600) / 60);
                const seconds_remaining = totalSeconds % 60;
                
                return {
                    ended: false,
                    totalSeconds,
                    hours: hours_remaining,
                    minutes: minutes_remaining,
                    seconds: seconds_remaining,
                    text: `${hours_remaining.toString().padStart(2, '0')}:${minutes_remaining.toString().padStart(2, '0')}:${seconds_remaining.toString().padStart(2, '0')}`
                };
            }
        };









        // Audio System (ç¨ç«‹ç‰ˆæœ¬ - ä¸ä¾è³´ Poe API)
        const AudioSystem = {
            audioContext: null,
            isInitialized: false,
            speechSynthesis: window.speechSynthesis,
            voices: [],
            isPlaying: false,
            speechQueue: [],

            // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
            async init() {
                if (this.isInitialized) return true;

                try {
                    // åˆå§‹åŒ– Web Audio API
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    // åˆå§‹åŒ–èªéŸ³åˆæˆ
                    this.initSpeechSynthesis();
                    
                    console.log('âœ… éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–æˆåŠŸ');
                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('âŒ éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                    return false;
                }
            },

            // åˆå§‹åŒ–èªéŸ³åˆæˆ
            initSpeechSynthesis() {
                if (!this.speechSynthesis) {
                    console.warn('âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆ');
                    return false;
                }

                // è¼‰å…¥å¯ç”¨èªéŸ³
                this.voices = this.speechSynthesis.getVoices();
                
                // å¦‚æœèªéŸ³åˆ—è¡¨ç‚ºç©ºï¼Œç­‰å¾…èªéŸ³è¼‰å…¥
                if (this.voices.length === 0) {
                    this.speechSynthesis.addEventListener('voiceschanged', () => {
                        this.voices = this.speechSynthesis.getVoices();
                        console.log(`âœ… è¼‰å…¥ ${this.voices.length} å€‹èªéŸ³`);
                    });
                }

                return true;
            },

            // é¸æ“‡æœ€ä½³ä¸­æ–‡èªéŸ³
            getBestChineseVoice() {
                if (!this.voices.length) {
                    this.voices = this.speechSynthesis.getVoices();
                }

                // å„ªå…ˆé †åºï¼šé¦™æ¸¯ç²µèª > å°ç£ä¸­æ–‡ > å¤§é™¸ä¸­æ–‡ > å…¶ä»–ä¸­æ–‡
                const priorities = [
                    /zh-HK|yue/i,    // é¦™æ¸¯ç²µèª
                    /zh-TW/i,        // å°ç£ä¸­æ–‡
                    /zh-CN/i,        // å¤§é™¸ä¸­æ–‡
                    /zh/i            // å…¶ä»–ä¸­æ–‡
                ];

                for (const pattern of priorities) {
                    const voice = this.voices.find(v => pattern.test(v.lang));
                    if (voice) return voice;
                }

                // å¦‚æœæ²’æœ‰ä¸­æ–‡èªéŸ³ï¼Œè¿”å›é è¨­èªéŸ³
                return this.voices[0] || null;
            },

            // æ’­æ”¾å¤šå€‹è€ƒè©¦æé†’ï¼ˆåˆä½µæ’­æ”¾é¿å…é‡ç–Šï¼‰
            async playMultipleAlerts(alerts) {
                if (alerts.length === 0) return;
                
                // æŒ‰åˆ†é˜æ•¸åˆ†çµ„
                const groupedByMinutes = {};
                alerts.forEach(alert => {
                    if (!groupedByMinutes[alert.minutes]) {
                        groupedByMinutes[alert.minutes] = [];
                    }
                    groupedByMinutes[alert.minutes].push(alert);
                });
                
                // ç‚ºæ¯å€‹æ™‚é–“é»ç”Ÿæˆåˆä½µçš„æé†’æ–‡å­—ï¼ŒæŒ‰å„ªå…ˆç´šæ’åº
                // å„ªå…ˆç´šï¼š1. è€ƒè©¦çµæŸ(0åˆ†é˜) 2. æœ€å¾Œ5åˆ†é˜ 3. æœ€å¾Œ15åˆ†é˜
                const messages = [];
                const priorityOrder = [0, 5, 15]; // æŒ‰é‡è¦æ€§æ’åº
                
                priorityOrder.forEach(minutes => {
                    if (groupedByMinutes[minutes]) {
                        const alertsForMinutes = groupedByMinutes[minutes];
                        const text = this.generateCombinedAlertText(minutes, alertsForMinutes);
                        if (text) {
                            messages.push(text);
                        }
                    }
                });
                
                // æŒ‰å„ªå…ˆç´šåˆ†åˆ¥æ’­æ”¾æé†’ï¼ˆè€Œä¸æ˜¯åˆä½µæˆä¸€å€‹ï¼‰
                if (messages.length > 0) {
                    console.log(`ğŸ”Š æŒ‰å„ªå…ˆç´šæ’­æ”¾ ${messages.length} å€‹æé†’: [${messages.join(', ')}]`);
                    for (const message of messages) {
                        console.log(`ğŸ“¢ æ·»åŠ åˆ°èªéŸ³éšŠåˆ—: "${message}"`);
                        await this.queueSpeech(message);
                    }
                } else {
                    console.warn('âš ï¸ æ²’æœ‰ç”Ÿæˆä»»ä½•æé†’è¨Šæ¯');
                }
            },
            
            // ç”Ÿæˆåˆä½µçš„æé†’æ–‡å­—
            generateCombinedAlertText(minutes, alerts) {
                if (alerts.length === 0) {
                    console.warn(`âš ï¸ generateCombinedAlertText: æ²’æœ‰æé†’æ•¸æ“š (minutes=${minutes})`);
                    return '';
                }
                
                // ç²å–ç§‘ç›®åç¨±
                const subjectNames = alerts.map(alert => {
                    return alert.subjectName || `è€ƒè©¦ç§‘ç›®${alert.subjectNumber}`;
                }).filter(name => name);
                
                let subjectText = '';
                if (subjectNames.length === 1) {
                    subjectText = subjectNames[0];
                } else if (subjectNames.length === 2) {
                    subjectText = `${subjectNames[0]}åŠ${subjectNames[1]}`;
                } else {
                    subjectText = 'å¤šå€‹è€ƒè©¦ç§‘ç›®';
                }
                
                let message = '';
                switch(minutes) {
                    case 15:
                        message = `${subjectText}è€ƒè©¦æ™‚é–“å°šé¤˜15åˆ†é˜`;
                        break;
                    case 5:
                        message = `${subjectText}è€ƒè©¦æ™‚é–“å°šé¤˜5åˆ†é˜`;
                        break;
                    case 0:
                        message = `${subjectText}è€ƒè©¦çµæŸï¼Œè«‹åœç­†`;
                        break;
                    default:
                        console.warn(`âš ï¸ æœªçŸ¥çš„åˆ†é˜æ•¸: ${minutes}`);
                        return '';
                }
                
                console.log(`ğŸ”Š ç”Ÿæˆæé†’æ–‡å­— (${minutes}åˆ†é˜): "${message}"`);
                return message;
            },

            // èªéŸ³éšŠåˆ—ç®¡ç†ç³»çµ±
            async queueSpeech(text) {
                return new Promise((resolve) => {
                    // æ·»åŠ åˆ°éšŠåˆ—
                    this.speechQueue.push({ text, resolve });
                    
                    // å¦‚æœç•¶å‰æ²’æœ‰æ’­æ”¾ï¼Œé–‹å§‹è™•ç†éšŠåˆ—
                    if (!this.isPlaying) {
                        this.processSpeechQueue();
                    }
                });
            },
            
            // è™•ç†èªéŸ³éšŠåˆ—
            async processSpeechQueue() {
                if (this.speechQueue.length === 0 || this.isPlaying) {
                    return;
                }
                
                this.isPlaying = true;
                
                while (this.speechQueue.length > 0) {
                    const { text, resolve } = this.speechQueue.shift();
                    
                    try {
                        console.log(`ğŸ”Š éšŠåˆ—æ’­æ”¾: ${text}`);
                        await this.playBeepAndSpeechSync(text);
                        resolve();
                    } catch (error) {
                        console.error('èªéŸ³æ’­æ”¾å¤±æ•—:', error);
                        this.showVisualAlert(text);
                        resolve();
                    }
                    
                    // åœ¨èªéŸ³ä¹‹é–“æ·»åŠ çŸ­æš«é–“éš”
                    if (this.speechQueue.length > 0) {
                        await this.delay(500);
                    }
                }
                
                this.isPlaying = false;
            },
            
            // å»¶é²å‡½æ•¸
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            // æ’­æ”¾è€ƒè©¦æé†’è²æ•ˆï¼ˆä¿ç•™å‘ä¸‹å…¼å®¹ï¼‰
            async playExamAlert(minutes, subjectNumber = null) {
                let text;
                let subjectText = '';
                
                if (subjectNumber === 1) {
                    // ç§‘ç›®1çš„æé†’
                    subjectText = AppState.examSubject1 || 'è€ƒè©¦ç§‘ç›®1';
                } else if (subjectNumber === 2) {
                    // ç§‘ç›®2çš„æé†’
                    subjectText = AppState.examSubject2 || 'è€ƒè©¦ç§‘ç›®2';
                } else {
                    // é€šç”¨æé†’ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
                    const subject1 = AppState.examSubject1;
                    const subject2 = AppState.examSubject2;
                    if (subject1 && subject2) {
                        subjectText = `${subject1}åŠ${subject2}`;
                    } else if (subject1) {
                        subjectText = subject1;
                    } else if (subject2) {
                        subjectText = subject2;
                    }
                }
                
                switch(minutes) {
                    case 15:
                        text = subjectText ? `${subjectText}è€ƒè©¦æ™‚é–“å°šé¤˜15åˆ†é˜` : 'è€ƒè©¦æ™‚é–“å°šé¤˜15åˆ†é˜';
                        break;
                    case 5:
                        text = subjectText ? `${subjectText}è€ƒè©¦æ™‚é–“å°šé¤˜5åˆ†é˜` : 'è€ƒè©¦æ™‚é–“å°šé¤˜5åˆ†é˜';
                        break;
                    case 0:
                        text = subjectText ? `${subjectText}è€ƒè©¦çµæŸï¼Œè«‹åœç­†` : 'è€ƒè©¦çµæŸï¼Œè«‹åœç­†';
                        break;
                    default:
                        console.warn(`æœªçŸ¥çš„åˆ†é˜æ•¸: ${minutes}`);
                        return;
                }
                
                console.log(`ğŸ”Š æ’­æ”¾æé†’: ${text}`);
                
                // ä½¿ç”¨éšŠåˆ—ç³»çµ±æ’­æ”¾
                await this.queueSpeech(text);
            },

            // æ’­æ”¾æç¤ºéŸ³å’ŒèªéŸ³ï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼Œç”¨æ–¼éšŠåˆ—ï¼‰
            async playBeepAndSpeechSync(text) {
                try {
                    // å…ˆæ’­æ”¾æç¤ºéŸ³
                    await this.playBeep();
                    
                    // ç­‰å¾…300mså¾Œæ’­æ”¾èªéŸ³
                    await this.delay(300);
                    
                    // æ’­æ”¾èªéŸ³ä¸¦ç­‰å¾…å®Œæˆ
                    await this.speakTextSync(text);
                    
                } catch (error) {
                    console.error('æ’­æ”¾éŸ³æ•ˆå¤±æ•—:', error);
                    // é™ç´šï¼šåªé¡¯ç¤ºè¦–è¦ºæé†’
                    this.showVisualAlert(text);
                }
            },
            
            // æ’­æ”¾æç¤ºéŸ³å’ŒèªéŸ³ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿æŒå‘ä¸‹å…¼å®¹ï¼‰
            async playBeepAndSpeech(text) {
                try {
                    // å…ˆæ’­æ”¾æç¤ºéŸ³
                    await this.playBeep();
                    
                    // ç¨ä½œå»¶é²å¾Œæ’­æ”¾èªéŸ³
                    setTimeout(() => {
                        this.speakText(text);
                    }, 300);
                    
                } catch (error) {
                    console.error('æ’­æ”¾éŸ³æ•ˆå¤±æ•—:', error);
                    // é™ç´šï¼šåªé¡¯ç¤ºè¦–è¦ºæé†’
                    this.showVisualAlert(text);
                }
            },

            // æ’­æ”¾æç¤ºéŸ³ï¼ˆä½¿ç”¨ Web Audio APIï¼‰
            async playBeep() {
                if (!this.audioContext) return;

                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // è¨­ç½®æç¤ºéŸ³åƒæ•¸
                    oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.5);
                    
                } catch (error) {
                    console.error('æ’­æ”¾æç¤ºéŸ³å¤±æ•—:', error);
                }
            },

            // èªéŸ³åˆæˆï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼Œè¿”å›Promiseï¼‰
            speakTextSync(text) {
                return new Promise((resolve, reject) => {
                    if (!this.speechSynthesis) {
                        console.warn('èªéŸ³åˆæˆä¸å¯ç”¨');
                        resolve();
                        return;
                    }

                    // åœæ­¢ç•¶å‰èªéŸ³
                    this.speechSynthesis.cancel();

                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // è¨­ç½®èªéŸ³åƒæ•¸
                    const voice = this.getBestChineseVoice();
                    if (voice) {
                        utterance.voice = voice;
                    }
                    
                    utterance.rate = 0.9;     // ç¨æ…¢çš„èªé€Ÿ
                    utterance.pitch = 1.0;    // æ­£å¸¸éŸ³èª¿
                    utterance.volume = 0.8;   // éŸ³é‡

                    // äº‹ä»¶è™•ç†
                    utterance.onstart = () => {
                        console.log('ğŸ—£ï¸ é–‹å§‹èªéŸ³æ’­æ”¾');
                    };
                    
                    utterance.onend = () => {
                        console.log('âœ… èªéŸ³æ’­æ”¾å®Œæˆ');
                        resolve();
                    };
                    
                    utterance.onerror = (event) => {
                        console.error('âŒ èªéŸ³æ’­æ”¾å¤±æ•—:', event.error);
                        reject(event.error);
                    };

                    this.speechSynthesis.speak(utterance);
                });
            },
            
            // èªéŸ³åˆæˆï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿æŒå‘ä¸‹å…¼å®¹ï¼‰
            speakText(text) {
                if (!this.speechSynthesis) {
                    console.warn('èªéŸ³åˆæˆä¸å¯ç”¨');
                    return;
                }

                // åœæ­¢ç•¶å‰èªéŸ³
                this.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                
                // è¨­ç½®èªéŸ³åƒæ•¸
                const voice = this.getBestChineseVoice();
                if (voice) {
                    utterance.voice = voice;
                }
                
                utterance.rate = 0.9;     // ç¨æ…¢çš„èªé€Ÿ
                utterance.pitch = 1.0;    // æ­£å¸¸éŸ³èª¿
                utterance.volume = 0.8;   // éŸ³é‡

                // äº‹ä»¶è™•ç†
                utterance.onstart = () => {
                    console.log('ğŸ—£ï¸ é–‹å§‹èªéŸ³æ’­æ”¾');
                };
                
                utterance.onend = () => {
                    console.log('âœ… èªéŸ³æ’­æ”¾å®Œæˆ');
                };
                
                utterance.onerror = (event) => {
                    console.error('âŒ èªéŸ³æ’­æ”¾å¤±æ•—:', event.error);
                };

                this.speechSynthesis.speak(utterance);
            },

            // è¦–è¦ºæé†’ï¼ˆé™ç´šæ–¹æ¡ˆï¼‰
            showVisualAlert(text) {
                console.log('ğŸ“¢ é¡¯ç¤ºè¦–è¦ºæé†’:', text);
                
                // å‰µå»ºæé†’å½ˆçª—
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-4 rounded-lg shadow-xl z-50 font-bold text-lg animate-pulse';
                alertDiv.textContent = text;
                
                document.body.appendChild(alertDiv);
                
                // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        };

        // Alert Checker
        const AlertChecker = {
            checkTimeAlerts() {
                const currentAlerts = []; // æ”¶é›†ç•¶å‰æ™‚åˆ»çš„æ‰€æœ‰æé†’
                
                // æª¢æŸ¥å…©å€‹ç§‘ç›®çš„æ™‚é–“æé†’
                ['subject1End', 'subject2End'].forEach(examKey => {
                    const endTime = AppState.examTimes[examKey];
                    const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                    
                    if (!timeRemaining) return;
                    
                    const specificMinutes = [15, 5, 0]; // æª¢æŸ¥15åˆ†é˜ã€5åˆ†é˜å’Œè€ƒè©¦çµæŸ
                    const subjectNumber = examKey === 'subject1End' ? 1 : 2;
                    
                    specificMinutes.forEach(targetMinutes => {
                        let shouldTrigger = false;
                        
                        if (targetMinutes === 0) {
                            // è€ƒè©¦çµæŸæª¢æŸ¥ - ç•¶æ™‚é–“åˆ°é”æˆ–å·²éæœŸæ™‚è§¸ç™¼
                            shouldTrigger = timeRemaining.ended;
                            console.log(`ğŸ” æª¢æŸ¥ç§‘ç›®${subjectNumber}è€ƒè©¦çµæŸ: ended=${timeRemaining.ended}, shouldTrigger=${shouldTrigger}`);
                        } else {
                            // 15åˆ†é˜å’Œ5åˆ†é˜æª¢æŸ¥ - åªåœ¨è€ƒè©¦æœªçµæŸæ™‚æª¢æŸ¥
                            if (!timeRemaining.ended) {
                                const totalMinutes = Math.floor(timeRemaining.totalSeconds / 60);
                                const seconds = timeRemaining.totalSeconds % 60;
                                shouldTrigger = (totalMinutes === targetMinutes && seconds <= 2);
                                if (shouldTrigger) {
                                    console.log(`ğŸ” æª¢æŸ¥ç§‘ç›®${subjectNumber} ${targetMinutes}åˆ†é˜æé†’: totalMinutes=${totalMinutes}, seconds=${seconds}`);
                                }
                            }
                        }
                        
                        if (shouldTrigger) {
                            const timeAlertKey = `${examKey}-${targetMinutes}mins`;
                            
                            if (!AppState.timeAlertHistory.has(timeAlertKey)) {
                                AppState.timeAlertHistory.add(timeAlertKey);
                                
                                console.log(`ğŸ”” è§¸ç™¼ç§‘ç›®${subjectNumber}æ™‚é–“æé†’: ${targetMinutes === 0 ? 'è€ƒè©¦çµæŸ' : targetMinutes + 'åˆ†é˜'}`);
                                
                                // æ”¶é›†æé†’è€Œä¸æ˜¯ç«‹å³æ’­æ”¾
                                currentAlerts.push({
                                    minutes: targetMinutes,
                                    subjectNumber: subjectNumber,
                                    subjectName: subjectNumber === 1 ? AppState.examSubject1 : AppState.examSubject2
                                });
                            }
                        }
                    });
                });
                
                // å¦‚æœæœ‰æé†’éœ€è¦æ’­æ”¾ï¼Œåˆä½µæ’­æ”¾
                if (currentAlerts.length > 0) {
                    AudioSystem.playMultipleAlerts(currentAlerts);
                }
            }
        };

        // Display Manager
        const DisplayManager = {
            updateDisplay() {
                const now = Utils.getHongKongTime();
                document.getElementById('currentTime').textContent = Utils.formatTime(now);
                document.getElementById('currentDate').textContent = Utils.formatDate(now);
                
                // Update exam countdown displays for both subjects
                ['subject1End', 'subject2End'].forEach(examKey => {
                    const endTime = AppState.examTimes[examKey];
                    const subjectNumber = examKey === 'subject1End' ? '1' : '2';
                    const timeDisplay = document.getElementById(`subject${subjectNumber}SessionTime`);
                    const container = document.getElementById(`subject${subjectNumber}Session`);
                    
                    if (!timeDisplay || !container) return;
                    
                    const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                    
                    if (!endTime) {
                        timeDisplay.textContent = '--:--:--';
                        container.className = 'py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded';
                    } else if (timeRemaining.ended) {
                        timeDisplay.textContent = timeRemaining.text;
                        container.className = 'py-2 px-3 border-2 border-accent bg-yellow-100 dark:bg-yellow-900 transition-all rounded';
                    } else {
                        timeDisplay.textContent = timeRemaining.text;
                        
                        let className = 'py-2 px-3 border-2 transition-all rounded ';
                        if (timeRemaining.totalSeconds <= 30) {
                            className += 'urgent-flash border-accent';
                        } else if (timeRemaining.totalSeconds <= 330) {
                            className += 'warning-flash border-warning';
                        } else if (timeRemaining.totalSeconds <= 930) {
                            className += 'warning-flash border-warning';
                        } else {
                            className += 'border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700';
                        }
                        container.className = className;
                    }
                });
                
                // Update time input displays
                Object.keys(AppState.examTimes).forEach(fieldId => {
                    TimePickerModal.updateDisplay(fieldId);
                });
            }
        };



        // Audio Status Manager
        const AudioStatusManager = {
            updateStatus(message, isError = false) {
                const statusElement = document.getElementById('audioStatusText');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = isError ? 'text-red-600 dark:text-red-400' : 'text-slate-600 dark:text-slate-400';
                }
            }
        };

        // Global Functions
        
        // Test Audio System Function (ç¨ç«‹ç‰ˆæœ¬)
        async function testAudioSystem() {
            const button = event.target;
            const originalText = button.textContent;
            
            try {
                button.disabled = true;
                button.textContent = 'ğŸµ æ¸¬è©¦ä¸­...';
                AudioStatusManager.updateStatus('æ­£åœ¨æ¸¬è©¦éŸ³æ•ˆç³»çµ±...');
                
                console.log('ğŸµ é–‹å§‹æ¸¬è©¦éŸ³æ•ˆç³»çµ±...');
                
                // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
                const initSuccess = await AudioSystem.init();
                if (!initSuccess) {
                    throw new Error('éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–å¤±æ•—');
                }
                
                AudioStatusManager.updateStatus('æ­£åœ¨æ¸¬è©¦èªéŸ³åˆæˆ...');
                
                // è¨­ç½®è‡¨æ™‚æ¸¬è©¦ç§‘ç›®
                const originalSubject1 = AppState.examSubject1;
                const originalSubject2 = AppState.examSubject2;
                AppState.examSubject1 = 'æ•¸å­¸ç§‘'; // ä½¿ç”¨æ•¸å­¸ç§‘ä½œç‚ºæ¸¬è©¦
                AppState.examSubject2 = 'è‹±æ–‡ç§‘';
                
                // æ¸¬è©¦å…©å€‹ç§‘ç›®çš„æé†’è²æ•ˆï¼ˆåŒ…æ‹¬åŒæ™‚æ’­æ”¾æ¸¬è©¦ï¼‰
                const testSequence = [
                    // å–®ç¨æé†’æ¸¬è©¦
                    { type: 'single', minutes: 15, subjectNumber: 1, delay: 0 },
                    { type: 'single', minutes: 5, subjectNumber: 2, delay: 2000 },
                    // åŒæ™‚æé†’æ¸¬è©¦ï¼ˆæ¨¡æ“¬å…©ç§‘ç›®åŒæ™‚çµæŸï¼‰
                    { type: 'multiple', delay: 4000 }
                ];
                
                for (const test of testSequence) {
                    setTimeout(async () => {
                        if (test.type === 'single') {
                            console.log(`æ¸¬è©¦ç§‘ç›®${test.subjectNumber} ${test.minutes === 0 ? 'è€ƒè©¦çµæŸ' : test.minutes + 'åˆ†é˜'} æé†’`);
                            await AudioSystem.playExamAlert(test.minutes, test.subjectNumber);
                        } else if (test.type === 'multiple') {
                            console.log('æ¸¬è©¦å„ªå…ˆç´šæ’åºï¼šçµæŸ + 5åˆ†é˜ + 15åˆ†é˜æé†’');
                            const multipleAlerts = [
                                { minutes: 0, subjectNumber: 1, subjectName: AppState.examSubject1 },   // è€ƒè©¦çµæŸ (æœ€é«˜å„ªå…ˆç´š)
                                { minutes: 5, subjectNumber: 2, subjectName: AppState.examSubject2 },   // 5åˆ†é˜æé†’
                                { minutes: 15, subjectNumber: 1, subjectName: AppState.examSubject1 }   // 15åˆ†é˜æé†’
                            ];
                            console.log('ğŸµ ç›´æ¥æ¸¬è©¦å¤šé‡æé†’ï¼Œç¢ºä¿è€ƒè©¦çµæŸæé†’åŒ…å«åœ¨å…§');
                            await AudioSystem.playMultipleAlerts(multipleAlerts);
                        }
                    }, test.delay);
                }
                
                // 7ç§’å¾Œæ¢å¾©åŸå§‹ç§‘ç›®
                setTimeout(() => {
                    AppState.examSubject1 = originalSubject1;
                    AppState.examSubject2 = originalSubject2;
                }, 7000);
                
                AudioStatusManager.updateStatus('âœ… éŸ³æ•ˆç³»çµ±æ¸¬è©¦å®Œæˆï¼');
                
                // 3ç§’å¾Œé‡ç½®ç‹€æ…‹
                setTimeout(() => {
                    AudioStatusManager.updateStatus('éŸ³æ•ˆç³»çµ±ï¼šå·²åˆå§‹åŒ–');
                }, 6000);
                
            } catch (error) {
                console.error('âŒ éŸ³æ•ˆç³»çµ±æ¸¬è©¦å¤±æ•—:', error);
                AudioStatusManager.updateStatus(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, true);
                
                // 3ç§’å¾Œé‡ç½®ç‹€æ…‹
                setTimeout(() => {
                    AudioStatusManager.updateStatus('éŸ³æ•ˆç³»çµ±ï¼šæ¸¬è©¦å¤±æ•—', true);
                }, 3000);
                
            } finally {
                // 3ç§’å¾Œæ¢å¾©æŒ‰éˆ•
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                }, 3000);
            }
        }
        
        // Subject Management
        function updateExamSubject(subjectNumber) {
            const subjectSelect = document.getElementById(`examSubject${subjectNumber}`);
            
            if (subjectNumber === 1) {
                AppState.examSubject1 = subjectSelect.value;
                console.log(`ğŸ“š è€ƒè©¦ç§‘ç›®1å·²æ›´æ–°: ${AppState.examSubject1 || 'æœªé¸æ“‡'}`);
            } else if (subjectNumber === 2) {
                AppState.examSubject2 = subjectSelect.value;
                console.log(`ğŸ“š è€ƒè©¦ç§‘ç›®2å·²æ›´æ–°: ${AppState.examSubject2 || 'æœªé¸æ“‡'}`);
            }
            
            // Clear alert histories when subject is changed
            AppState.alertHistory.clear();
            AppState.timeAlertHistory.clear();
        }

        function resetAllTimes() {
            // Clear all exam times
            Object.keys(AppState.examTimes).forEach(key => {
                AppState.examTimes[key] = '';
                const input = document.getElementById(key);
                if (input) input.value = '';
            });
            
            // Clear exam subjects
            AppState.examSubject1 = '';
            AppState.examSubject2 = '';
            const subjectSelect1 = document.getElementById('examSubject1');
            const subjectSelect2 = document.getElementById('examSubject2');
            if (subjectSelect1) subjectSelect1.value = '';
            if (subjectSelect2) subjectSelect2.value = '';
            updateExamSubject(1);
            updateExamSubject(2);
            
            AppState.alertHistory.clear();
            AppState.timeAlertHistory.clear();
            
            // Clear all timers
            AppState.timers.forEach(timer => clearInterval(timer));
            AppState.timers.clear();
            
            DisplayManager.updateDisplay();
        }

        // Application Initialization (ç¨ç«‹ç‰ˆæœ¬)
        function initApp() {
            try {
                // Initialize dark mode
                DarkMode.init();
                
                // Initialize displays
                DisplayManager.updateDisplay();
                updateExamSubject(1);
                updateExamSubject(2);
                
                // Initialize audio system
                AudioSystem.init().then(success => {
                    if (success) {
                        AudioStatusManager.updateStatus('éŸ³æ•ˆç³»çµ±ï¼šå·²åˆå§‹åŒ–');
                        console.log('âœ… éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–æˆåŠŸ');
                    } else {
                        AudioStatusManager.updateStatus('éŸ³æ•ˆç³»çµ±ï¼šåˆå§‹åŒ–å¤±æ•—', true);
                        console.warn('âš ï¸ éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œå°‡ä½¿ç”¨é™ç´šæ¨¡å¼');
                    }
                }).catch(error => {
                    AudioStatusManager.updateStatus('éŸ³æ•ˆç³»çµ±ï¼šåˆå§‹åŒ–å¤±æ•—', true);
                    console.error('âŒ éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–éŒ¯èª¤:', error);
                });
                
                // Start main update loop
                setInterval(() => {
                    DisplayManager.updateDisplay();
                    AlertChecker.checkTimeAlerts();
                }, 1000);
                
                // Add click outside modal to close
                document.getElementById('timePickerModal').addEventListener('click', function(event) {
                    if (event.target === this) {
                        TimePickerModal.close();
                    }
                });
                
                // Add keyboard support for time input displays
                document.querySelectorAll('.time-input-display').forEach(element => {
                    element.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            this.click();
                        }
                    });
                });
                
                console.log('âœ… è€ƒè©¦å ±æ™‚æé†’ç³»çµ±å·²åˆå§‹åŒ–');
                
            } catch (error) {
                console.error('âŒ æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—:', error);
            }
        }

        // Error Handling
        window.addEventListener('error', (event) => {
            console.error('JavaScriptéŒ¯èª¤:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªè™•ç†çš„Promiseæ‹’çµ•:', event.reason);
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Page Visibility API
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('æ‡‰ç”¨ç¨‹å¼å·²æš«åœ');
            } else {
                console.log('æ‡‰ç”¨ç¨‹å¼å·²æ¢å¾©');
            }
        });
    </script>
</body>
</html>
