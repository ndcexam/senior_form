<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ËÄÉË©¶Â†±ÊôÇÊèêÈÜíÁ≥ªÁµ± - Â∞àÊ•≠ÁöÑËÄÉË©¶ÊôÇÈñìÁÆ°ÁêÜÂ∑•ÂÖ∑">
    <meta name="keywords" content="ËÄÉË©¶, Â†±ÊôÇ, ÊèêÈÜí, ÊôÇÈñìÁÆ°ÁêÜ, Â≠∏Ê†°">
    <meta name="author" content="Examination Timing Alert System">
   
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
   
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./images/favicon.png">
   
    <title>ËÄÉË©¶Â†±ÊôÇÊèêÈÜíÁ≥ªÁµ±</title>
   
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- TailwindCSS Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E3A8A',
                        secondary: '#374151',
                        accent: '#D97706',
                        warning: '#D97706',
                        surface: '#F8FAFC',
                        'surface-dark': '#0F172A'
                    },
                    fontFamily: {
                        'mono': ['Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>
   
    <!-- Custom Styles -->
    <style>
        /* Animation Styles */
        .warning-flash {
            animation: flash 2s infinite;
        }
       
        @keyframes flash {
            0%, 50% {
                background-color: #FEF3C7;
                border-color: #D97706;
            }
            51%, 100% {
                background-color: #F59E0B;
                border-color: #92400E;
            }
        }
       
        .dark .warning-flash {
            animation: flash-dark 2s infinite;
        }
       
        @keyframes flash-dark {
            0%, 50% {
                background-color: #92400E;
                border-color: #D97706;
            }
            51%, 100% {
                background-color: #B45309;
                border-color: #F59E0B;
            }
        }
       
        .urgent-flash {
            animation: urgent 1s infinite;
        }
       
        @keyframes urgent {
            0%, 50% {
                background-color: #FEF3C7;
                border-color: #D97706;
            }
            51%, 100% {
                background-color: #F59E0B;
                border-color: #92400E;
            }
        }
       
        .dark .urgent-flash {
            animation: urgent-dark 1s infinite;
        }
       
        @keyframes urgent-dark {
            0%, 50% {
                background-color: #92400E;
                border-color: #D97706;
            }
            51%, 100% {
                background-color: #B45309;
                border-color: #F59E0B;
            }
        }
       
        /* Enhanced Visual Effects */
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
       
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.95);
        }
       
        .time-display {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            min-height: 1.5rem;
            display: flex;
            align-items: center;
        }
       
        .dark .time-display {
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
        }
       
        /* Time Input Display */
        .time-input-display {
            cursor: pointer;
            transition: all 0.2s ease;
        }
       
        .time-input-display:hover {
            background-color: #F1F5F9;
            border-color: #1E3A8A;
        }
       
        .dark .time-input-display:hover {
            background-color: #475569;
            border-color: #3B82F6;
        }
       
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
       
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
       
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
        }
       
        .dark .modal-content {
            background: #1e293b;
            border: 1px solid #475569;
        }
       
        .modal-overlay.show .modal-content {
            transform: scale(1) translateY(0);
        }
       
        /* Time Picker Styles */
        .time-picker {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            margin: 1.5rem 0;
        }
       
        .time-input {
            width: 80px;
            height: 60px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            font-family: monospace;
            font-weight: bold;
        }
       
        .dark .time-input {
            background: #374151;
            border-color: #6b7280;
            color: white;
        }
       
        .time-input:focus {
            outline: none;
            border-color: #1E3A8A;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
       
        .time-separator {
            font-size: 2rem;
            font-weight: bold;
            color: #64748b;
        }
       
        .dark .time-separator {
            color: #94a3b8;
        }
       
        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
           
            .dark .warning-flash,
            .dark .urgent-flash {
                background-color: #92400E !important;
            }
           
            .modal-overlay,
            .modal-content {
                transition: none;
            }
        }
       
        /* Print Styles */
        @media print {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
           
            body {
                background: white !important;
                color: black !important;
            }
           
            .modal-overlay {
                display: none !important;
            }
        }
       
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 640px) {
            .time-display {
                font-size: 3rem !important;
            }
           
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
           
            .time-picker {
                flex-direction: column;
                gap: 0.5rem;
            }
           
            .time-input {
                width: 100px;
                height: 50px;
                font-size: 1.25rem;
            }
        }
       
        /* Focus Indicators */
        input:focus,
        button:focus {
            outline: 2px solid #1E3A8A;
            outline-offset: 2px;
        }
       
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen font-sans">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-white px-4 py-2 rounded">
        Ë∑≥Ëá≥‰∏ªË¶ÅÂÖßÂÆπ
    </a>

    <!-- Header -->
    <header class="bg-primary dark:bg-slate-800 border-b-4 border-accent shadow-lg">
        <div class="container mx-auto p-6 max-w-7xl">
            <div class="flex items-center justify-center gap-6">
                <img
                    src="./images/NDC_school_logov2.png"
                    alt="Â≠∏Ê†°Ê†°ÂæΩ"
                    class="h-16 w-16 object-contain"
                    loading="eager"
                    onerror="this.style.display='none'"
                >
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-white tracking-wider">
                        ËÄÉË©¶Â†±ÊôÇÊèêÈÜíÁ≥ªÁµ±
                    </h1>
                    <p class="text-blue-100 dark:text-slate-300 mt-2 text-lg">
                        EXAMINATION TIMING ALERT SYSTEM
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-6 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-[25%_25%_50%] gap-8">
           
            <!-- Time Configuration Panel -->
            <section class="order-1 lg:order-1" aria-labelledby="config-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg h-full">
                    <header class="bg-secondary text-white p-4 border-b-2 border-slate-300 dark:border-slate-600 rounded-t-lg">
                        <h2 id="config-title" class="text-xl font-bold text-center tracking-wide">
                            ËÄÉË©¶ÊôÇÈñìË®≠ÂÆö
                        </h2>
                        <p class="text-center text-slate-200 text-sm mt-1">
                            EXAM TIME CONFIGURATION
                        </p>
                    </header>
                   
                    <div class="p-6">
                        <!-- Form 4 Configuration -->
                        <div class="mb-8">
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∏ÄÁØÄ SESSION 1</div>
                                <div id="form1End1Display"
                                     class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display"
                                     onclick="TimePickerModal.open('form1End1')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Ë®≠ÂÆö‰∏≠ÂõõÂπ¥Á¥öÁ¨¨‰∏ÄÁØÄËÄÉË©¶ÁµêÊùüÊôÇÈñì">
                                    <div class="text-base font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∫åÁØÄ SESSION 2</div>
                                <div id="form1End2Display"
                                     class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display"
                                     onclick="TimePickerModal.open('form1End2')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Ë®≠ÂÆö‰∏≠ÂõõÂπ¥Á¥öÁ¨¨‰∫åÁØÄËÄÉË©¶ÁµêÊùüÊôÇÈñì">
                                    <div class="text-base font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </section>

            <!-- Time Display Panel -->
            <section class="order-1 lg:order-2" aria-labelledby="remaining-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg h-full">
                    <header class="bg-secondary text-white p-4 border-b-2 border-slate-300 dark:border-slate-600 rounded-t-lg">
                        <h2 id="remaining-title" class="text-xl font-bold text-center tracking-wide">
                            Ââ©È§òÊôÇÈñì
                        </h2>
                        <p class="text-center text-slate-200 text-sm mt-1">
                            REMAINING TIME
                        </p>
                    </header>
                   
                    <div class="p-6">
                        <!-- Form 4 Times -->
                        <div class="mb-8">
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∏ÄÁØÄ SESSION 1</div>
                                <div id="form1Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form1Session1Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∫åÁØÄ SESSION 2</div>
                                <div id="form1Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form1Session2Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </section>

            <!-- Clock and Alerts Panel -->
            <section class="order-3 lg:order-3">
                <!-- Current Time Display -->
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl mb-8 rounded-lg">
                    <header class="bg-primary text-white p-4 border-b-2 border-blue-800 rounded-t-lg">
                        <h2 class="text-xl font-bold text-center tracking-wide">È¶ôÊ∏ØÊ®ôÊ∫ñÊôÇÈñì</h2>
                        <p class="text-center text-blue-100 text-sm mt-1">HONG KONG STANDARD TIME</p>
                    </header>
                    <div class="p-8 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 rounded-b-lg">
                        <div class="text-center">
                            <time
                                id="currentTime"
                                class="text-6xl xl:text-7xl font-bold font-mono text-primary dark:text-blue-300 time-display tracking-wider mb-4 block"
                                role="timer"
                                aria-live="polite"
                            ></time>
                            <div id="currentDate" class="text-lg text-slate-600 dark:text-slate-400 font-medium"></div>
                        </div>
                    </div>
                </div>
               

            </section>
        </div>
       
        <!-- Control Buttons Section -->
        <div class="mt-8 text-center space-y-4">
            <!-- Audio Test Button -->
            <div>
                <button
                    onclick="testAudioSystem()"
                    class="bg-accent hover:bg-yellow-600 text-white py-3 px-8 font-semibold tracking-wide uppercase transition-colors border-2 border-accent hover:border-yellow-600 rounded-lg shadow-lg hover:shadow-xl focus:ring-2 focus:ring-offset-2 focus:ring-accent mr-4"
                    aria-describedby="audio-test-desc"
                >
                    üéµ Ê∏¨Ë©¶Èü≥ÊïàÁ≥ªÁµ± TEST AUDIO
                </button>
                <span id="audio-test-desc" class="sr-only">Ê∏¨Ë©¶Èü≥ÊïàÊí≠ÊîæÂäüËÉΩ</span>
               
                <!-- Audio Status Indicator -->
                <div id="audioStatus" class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                    <span id="audioStatusText">Èü≥ÊïàÁ≥ªÁµ±ÔºöÊú™ÂàùÂßãÂåñ</span>
                </div>
            </div>
           
            <!-- Reset Button -->
            <div>
                <button
                    onclick="resetAllTimes()"
                    class="bg-secondary hover:bg-slate-600 text-white py-3 px-8 font-semibold tracking-wide uppercase transition-colors border-2 border-secondary hover:border-slate-600 rounded-lg shadow-lg hover:shadow-xl focus:ring-2 focus:ring-offset-2 focus:ring-secondary"
                    aria-describedby="reset-desc"
                >
                    ÈáçÁΩÆÊâÄÊúâË®≠ÂÆö RESET ALL
                </button>
                <span id="reset-desc" class="sr-only">Ê∏ÖÈô§ÊâÄÊúâÊôÇÈñìË®≠ÂÆö</span>
            </div>
        </div>
    </main>

    <!-- Time Picker Modal -->
    <div id="timePickerModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-center mb-4 text-slate-900 dark:text-slate-100">Ë®≠ÂÆöËÄÉË©¶ÁµêÊùüÊôÇÈñì</h3>
           
            <div class="time-picker">
                <div>
                    <label for="hourInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center">Â∞èÊôÇ</label>
                    <input type="number" id="hourInput" class="time-input" min="0" max="23" placeholder="HH">
                </div>
               
                <div class="time-separator">:</div>
               
                <div>
                    <label for="minuteInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center">ÂàÜÈêò</label>
                    <input type="number" id="minuteInput" class="time-input" min="0" max="59" placeholder="MM">
                </div>
            </div>
           
            <div class="flex gap-3 justify-center mt-6">
                <button onclick="TimePickerModal.save()" class="bg-primary hover:bg-blue-800 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    Á¢∫ÂÆö
                </button>
                <button onclick="TimePickerModal.clear()" class="bg-warning hover:bg-yellow-600 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-warning">
                    Ê∏ÖÈô§
                </button>
                <button onclick="TimePickerModal.close()" class="bg-slate-500 hover:bg-slate-600 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                    ÂèñÊ∂à
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden input fields for backwards compatibility -->
    <div style="display: none;">
        <input type="time" id="form1End1">
        <input type="time" id="form1End2">
    </div>

    <!-- JavaScript Application -->
    <script>
        'use strict';
       
        // Application State
        const AppState = {
            alertHistory: new Set(),
            timeAlertHistory: new Set(),
            isPlayingAudio: false,
            timers: new Map(),
            examTimes: {
                form1End1: '',
                form1End2: ''
            },

        };

        // Time Picker Modal
        const TimePickerModal = {
            currentField: null,
           
            open(fieldId) {
                this.currentField = fieldId;
                const modal = document.getElementById('timePickerModal');
                const hourInput = document.getElementById('hourInput');
                const minuteInput = document.getElementById('minuteInput');
               
                // Get current time value
                const currentTime = AppState.examTimes[fieldId];
                if (currentTime) {
                    const [hours, minutes] = currentTime.split(':');
                    hourInput.value = parseInt(hours).toString();
                    minuteInput.value = parseInt(minutes).toString();
                } else {
                    hourInput.value = '';
                    minuteInput.value = '';
                }
               
                modal.classList.add('show');
               
                // Focus first input
                setTimeout(() => {
                    hourInput.focus();
                }, 100);
               
                // Add keyboard listeners
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
            },
           
            close() {
                const modal = document.getElementById('timePickerModal');
                modal.classList.remove('show');
                this.currentField = null;
               
                // Remove keyboard listeners
                document.removeEventListener('keydown', this.handleKeyDown.bind(this));
            },
           
            async save() {
                const hourInput = document.getElementById('hourInput');
                const minuteInput = document.getElementById('minuteInput');
               
                let hours = parseInt(hourInput.value) || 0;
                let minutes = parseInt(minuteInput.value) || 0;
               
                // Validate input
                if (hours < 0 || hours > 23) {
                    this.showValidationMessage('Â∞èÊôÇÂøÖÈ†àÂú® 0-23 ‰πãÈñì');
                    hourInput.focus();
                    return;
                }
               
                if (minutes < 0 || minutes > 59) {
                    this.showValidationMessage('ÂàÜÈêòÂøÖÈ†àÂú® 0-59 ‰πãÈñì');
                    minuteInput.focus();
                    return;
                }
               
                // Format time
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
               

               
                // Update state and display
                AppState.examTimes[this.currentField] = timeString;
               
                // ÂÆâÂÖ®Âú∞Ë®≠ÁΩÆÈö±ËóèinputÁöÑÂÄº
                const hiddenInput = document.getElementById(this.currentField);
                if (hiddenInput) {
                    hiddenInput.value = timeString;
                }
               
                this.updateDisplay(this.currentField);
               
                // Clear alert histories when time is changed
                AppState.alertHistory.clear();
                AppState.timeAlertHistory.clear();
               

               
                this.close();
               
                // Update main display
                DisplayManager.updateDisplay();
            },
           
            clear() {
                AppState.examTimes[this.currentField] = '';
               
                // ÂÆâÂÖ®Âú∞Ê∏ÖÈô§Èö±ËóèinputÁöÑÂÄº
                const hiddenInput = document.getElementById(this.currentField);
                if (hiddenInput) {
                    hiddenInput.value = '';
                }
               
                this.updateDisplay(this.currentField);
               
                // Clear alert histories
                AppState.alertHistory.clear();
                AppState.timeAlertHistory.clear();
               
                this.close();
               
                // Update main display
                DisplayManager.updateDisplay();
            },
           
            updateDisplay(fieldId) {
                const displayElement = document.getElementById(fieldId + 'Display');
                if (!displayElement) {
                    console.warn(`È°ØÁ§∫ÂÖÉÁ¥†‰∏çÂ≠òÂú®: ${fieldId}Display`);
                    return;
                }
               
                const timeDiv = displayElement.querySelector('.time-display');
                if (!timeDiv) {
                    console.warn(`ÊôÇÈñìÈ°ØÁ§∫ÂÖÉÁ¥†‰∏çÂ≠òÂú®: .time-display in ${fieldId}Display`);
                    return;
                }
               
                const timeValue = AppState.examTimes[fieldId];
               
                if (timeValue) {
                    timeDiv.textContent = timeValue;
                } else {
                    timeDiv.textContent = '--:--';
                }
            },
           
            showValidationMessage(message) {
                // Create custom validation message
                const modal = document.querySelector('.modal-content');
               
                // Remove existing validation message
                const existingMessage = modal.querySelector('.validation-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
               
                // Create new validation message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'validation-message bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded mb-4';
                messageDiv.textContent = message;
               
                // Insert before time picker
                const timePicker = modal.querySelector('.time-picker');
                modal.insertBefore(messageDiv, timePicker);
               
                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 3000);
            },
           
            handleKeyDown(event) {
                if (event.key === 'Escape') {
                    this.close();
                } else if (event.key === 'Enter') {
                    this.save();
                }
            }
        };

        // Utility Functions
        const Utils = {
            formatTime(date) {
                return date.toLocaleTimeString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            formatDate(date) {
                return date.toLocaleDateString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            },

            getHongKongTime() {
                return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Dark Mode Manager
        const DarkMode = {
            init() {
                // Initial check
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
               
                // Listen for changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
        };

        // Time Calculator
        const TimeCalculator = {
            calculateTimeRemaining(endTime) {
                if (!endTime) return null;
               
                const now = Utils.getHongKongTime();
                const [hours, minutes] = endTime.split(':');
                const examEnd = new Date(now);
                examEnd.setHours(parseInt(hours), parseInt(minutes), 0, 0);
               
                if (examEnd < now) {
                    examEnd.setDate(examEnd.getDate() + 1);
                }
               
                const diff = examEnd - now;
               
                if (diff <= 0) {
                    return { ended: true, text: 'ËÄÉË©¶Â∑≤ÁµêÊùü' };
                }
               
                const totalSeconds = Math.floor(diff / 1000);
                const hours_remaining = Math.floor(totalSeconds / 3600);
                const minutes_remaining = Math.floor((totalSeconds % 3600) / 60);
                const seconds_remaining = totalSeconds % 60;
               
                return {
                    ended: false,
                    totalSeconds,
                    hours: hours_remaining,
                    minutes: minutes_remaining,
                    seconds: seconds_remaining,
                    text: `${hours_remaining.toString().padStart(2, '0')}:${minutes_remaining.toString().padStart(2, '0')}:${seconds_remaining.toString().padStart(2, '0')}`
                };
            }
        };









        // Audio System (Áç®Á´ãÁâàÊú¨ - ‰∏ç‰æùË≥¥ Poe API)
        const AudioSystem = {
            audioContext: null,
            isInitialized: false,
            speechSynthesis: window.speechSynthesis,
            voices: [],

            // ÂàùÂßãÂåñÈü≥ÊïàÁ≥ªÁµ±
            async init() {
                if (this.isInitialized) return true;

                try {
                    // ÂàùÂßãÂåñ Web Audio API
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                   
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                   
                    // ÂàùÂßãÂåñË™ûÈü≥ÂêàÊàê
                    this.initSpeechSynthesis();
                   
                    console.log('‚úÖ Èü≥ÊïàÁ≥ªÁµ±ÂàùÂßãÂåñÊàêÂäü');
                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('‚ùå Èü≥ÊïàÁ≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó:', error);
                    return false;
                }
            },

            // ÂàùÂßãÂåñË™ûÈü≥ÂêàÊàê
            initSpeechSynthesis() {
                if (!this.speechSynthesis) {
                    console.warn('‚ö†Ô∏è ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥ÂêàÊàê');
                    return false;
                }

                // ËºâÂÖ•ÂèØÁî®Ë™ûÈü≥
                this.voices = this.speechSynthesis.getVoices();
               
                // Â¶ÇÊûúË™ûÈü≥ÂàóË°®ÁÇ∫Á©∫ÔºåÁ≠âÂæÖË™ûÈü≥ËºâÂÖ•
                if (this.voices.length === 0) {
                    this.speechSynthesis.addEventListener('voiceschanged', () => {
                        this.voices = this.speechSynthesis.getVoices();
                        console.log(`‚úÖ ËºâÂÖ• ${this.voices.length} ÂÄãË™ûÈü≥`);
                    });
                }

                return true;
            },

            // ÈÅ∏ÊìáÊúÄ‰Ω≥‰∏≠ÊñáË™ûÈü≥
            getBestChineseVoice() {
                if (!this.voices.length) {
                    this.voices = this.speechSynthesis.getVoices();
                }

                // ÂÑ™ÂÖàÈ†ÜÂ∫èÔºöÈ¶ôÊ∏ØÁ≤µË™û > Âè∞ÁÅ£‰∏≠Êñá > Â§ßÈô∏‰∏≠Êñá > ÂÖ∂‰ªñ‰∏≠Êñá
                const priorities = [
                    /zh-HK|yue/i,    // È¶ôÊ∏ØÁ≤µË™û
                    /zh-TW/i,        // Âè∞ÁÅ£‰∏≠Êñá
                    /zh-CN/i,        // Â§ßÈô∏‰∏≠Êñá
                    /zh/i            // ÂÖ∂‰ªñ‰∏≠Êñá
                ];

                for (const pattern of priorities) {
                    const voice = this.voices.find(v => pattern.test(v.lang));
                    if (voice) return voice;
                }

                // Â¶ÇÊûúÊ≤íÊúâ‰∏≠ÊñáË™ûÈü≥ÔºåËøîÂõûÈ†êË®≠Ë™ûÈü≥
                return this.voices[0] || null;
            },

            // Êí≠ÊîæËÄÉË©¶ÊèêÈÜíËÅ≤Êïà
            async playExamAlert(minutes) {
                let text;
               
                switch(minutes) {
                    case 15:
                        text = 'ËÄÉË©¶ÊôÇÈñìÂ∞öÈ§ò15ÂàÜÈêò';
                        break;
                    case 5:
                        text = 'ËÄÉË©¶ÊôÇÈñìÂ∞öÈ§ò5ÂàÜÈêò';
                        break;
                    case 0:
                        text = 'ËÄÉË©¶ÁµêÊùüÔºåË´ãÂÅúÁ≠Ü';
                        break;
                    default:
                        console.warn(`Êú™Áü•ÁöÑÂàÜÈêòÊï∏: ${minutes}`);
                        return;
                }
               
                console.log(`üîä Êí≠ÊîæÊèêÈÜí: ${text}`);
               
                // ÂòóË©¶Êí≠ÊîæÊèêÁ§∫Èü≥ + Ë™ûÈü≥
                await this.playBeepAndSpeech(text);
            },

            // Êí≠ÊîæÊèêÁ§∫Èü≥ÂíåË™ûÈü≥
            async playBeepAndSpeech(text) {
                try {
                    // ÂÖàÊí≠ÊîæÊèêÁ§∫Èü≥
                    await this.playBeep();
                   
                    // Á®ç‰ΩúÂª∂ÈÅ≤ÂæåÊí≠ÊîæË™ûÈü≥
                    setTimeout(() => {
                        this.speakText(text);
                    }, 300);
                   
                } catch (error) {
                    console.error('Êí≠ÊîæÈü≥ÊïàÂ§±Êïó:', error);
                    // ÈôçÁ¥öÔºöÂè™È°ØÁ§∫Ë¶ñË¶∫ÊèêÈÜí
                    this.showVisualAlert(text);
                }
            },

            // Êí≠ÊîæÊèêÁ§∫Èü≥Ôºà‰ΩøÁî® Web Audio APIÔºâ
            async playBeep() {
                if (!this.audioContext) return;

                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                   
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                   
                    // Ë®≠ÁΩÆÊèêÁ§∫Èü≥ÂèÉÊï∏
                    oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                   
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.5);
                   
                } catch (error) {
                    console.error('Êí≠ÊîæÊèêÁ§∫Èü≥Â§±Êïó:', error);
                }
            },

            // Ë™ûÈü≥ÂêàÊàê
            speakText(text) {
                if (!this.speechSynthesis) {
                    console.warn('Ë™ûÈü≥ÂêàÊàê‰∏çÂèØÁî®');
                    return;
                }

                // ÂÅúÊ≠¢Áï∂ÂâçË™ûÈü≥
                this.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
               
                // Ë®≠ÁΩÆË™ûÈü≥ÂèÉÊï∏
                const voice = this.getBestChineseVoice();
                if (voice) {
                    utterance.voice = voice;
                }
               
                utterance.rate = 0.9;     // Á®çÊÖ¢ÁöÑË™ûÈÄü
                utterance.pitch = 1.0;    // Ê≠£Â∏∏Èü≥Ë™ø
                utterance.volume = 0.8;   // Èü≥Èáè

                // ‰∫ã‰ª∂ËôïÁêÜ
                utterance.onstart = () => {
                    console.log('üó£Ô∏è ÈñãÂßãË™ûÈü≥Êí≠Êîæ');
                };
               
                utterance.onend = () => {
                    console.log('‚úÖ Ë™ûÈü≥Êí≠ÊîæÂÆåÊàê');
                };
               
                utterance.onerror = (event) => {
                    console.error('‚ùå Ë™ûÈü≥Êí≠ÊîæÂ§±Êïó:', event.error);
                };

                this.speechSynthesis.speak(utterance);
            },

            // Ë¶ñË¶∫ÊèêÈÜíÔºàÈôçÁ¥öÊñπÊ°àÔºâ
            showVisualAlert(text) {
                console.log('üì¢ È°ØÁ§∫Ë¶ñË¶∫ÊèêÈÜí:', text);
               
                // ÂâµÂª∫ÊèêÈÜíÂΩàÁ™ó
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-4 rounded-lg shadow-xl z-50 font-bold text-lg animate-pulse';
                alertDiv.textContent = text;
               
                document.body.appendChild(alertDiv);
               
                // 3ÁßíÂæåËá™ÂãïÁßªÈô§
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        };

        // Alert Checker
        const AlertChecker = {
            checkTimeAlerts() {
                const forms = ['form1'];
                const sessions = ['Session1', 'Session2'];
               
                const specificMinutes = [15, 5, 0]; // Ê™¢Êü•15ÂàÜÈêò„ÄÅ5ÂàÜÈêòÂíåËÄÉË©¶ÁµêÊùü
               
                specificMinutes.forEach(targetMinutes => {
                    forms.forEach((form) => {
                        sessions.forEach((session, sessionIndex) => {
                            const endTime = AppState.examTimes[`${form}End${sessionIndex + 1}`];
                            const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                           
                            if (!timeRemaining) return;
                           
                            let shouldTrigger = false;
                           
                            if (targetMinutes === 0) {
                                // ËÄÉË©¶ÁµêÊùüÊ™¢Êü•
                                shouldTrigger = timeRemaining.ended;
                            } else {
                                // 15ÂàÜÈêòÂíå5ÂàÜÈêòÊ™¢Êü•
                                if (!timeRemaining.ended) {
                                    const totalMinutes = Math.floor(timeRemaining.totalSeconds / 60);
                                    const seconds = timeRemaining.totalSeconds % 60;
                                    shouldTrigger = (totalMinutes === targetMinutes && seconds <= 2);
                                }
                            }
                           
                            if (shouldTrigger) {
                                const timeAlertKey = `${form}-${session}-${targetMinutes}mins`;
                               
                                if (!AppState.timeAlertHistory.has(timeAlertKey)) {
                                    AppState.timeAlertHistory.add(timeAlertKey);
                                   
                                    console.log(`üîî Ëß∏ÁôºÊôÇÈñìÊèêÈÜí: ${targetMinutes === 0 ? 'ËÄÉË©¶ÁµêÊùü' : targetMinutes + 'ÂàÜÈêò'}`);
                                   
                                    // Êí≠ÊîæËÅ≤Êïà
                                    AudioSystem.playExamAlert(targetMinutes);
                                }
                            }
                        });
                    });
                });
            }
        };

        // Display Manager
        const DisplayManager = {
            updateDisplay() {
                const now = Utils.getHongKongTime();
                document.getElementById('currentTime').textContent = Utils.formatTime(now);
                document.getElementById('currentDate').textContent = Utils.formatDate(now);
               
                const forms = ['form1'];
                const sessions = ['Session1', 'Session2'];
               
                forms.forEach((form, formIndex) => {
                    sessions.forEach((session, sessionIndex) => {
                        const endTime = AppState.examTimes[`${form}End${sessionIndex + 1}`];
                        const timeDisplay = document.getElementById(`${form}${session}Time`);
                        const container = document.getElementById(`${form}${session}`);
                       
                        const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                       
                        if (!endTime) {
                            timeDisplay.textContent = '--:--:--';
                            container.className = container.className.replace(/warning-flash|urgent-flash|border-accent|border-warning/g, '').trim() + ' py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded';
                        } else if (timeRemaining.ended) {
                            timeDisplay.textContent = timeRemaining.text;
                            container.className = 'py-3 px-4 border-2 border-accent bg-yellow-100 dark:bg-yellow-900 transition-all rounded';
                        } else {
                            timeDisplay.textContent = timeRemaining.text;
                           
                            let className = 'py-3 px-4 border-2 transition-all rounded ';
                            if (timeRemaining.totalSeconds <= 30) {
                                className += 'urgent-flash border-accent';
                            } else if (timeRemaining.totalSeconds <= 330) {
                                className += 'warning-flash border-warning';
                            } else if (timeRemaining.totalSeconds <= 930) {
                                className += 'warning-flash border-warning';
                            } else {
                                className += 'border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700';
                            }
                            container.className = className;
                        }
                    });
                });
               
                // Update time input displays
                Object.keys(AppState.examTimes).forEach(fieldId => {
                    TimePickerModal.updateDisplay(fieldId);
                });
            }
        };



        // Audio Status Manager
        const AudioStatusManager = {
            updateStatus(message, isError = false) {
                const statusElement = document.getElementById('audioStatusText');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = isError ? 'text-red-600 dark:text-red-400' : 'text-slate-600 dark:text-slate-400';
                }
            }
        };

        // Global Functions
       
        // Test Audio System Function (Áç®Á´ãÁâàÊú¨)
        async function testAudioSystem() {
            const button = event.target;
            const originalText = button.textContent;
           
            try {
                button.disabled = true;
                button.textContent = 'üéµ Ê∏¨Ë©¶‰∏≠...';
                AudioStatusManager.updateStatus('Ê≠£Âú®Ê∏¨Ë©¶Èü≥ÊïàÁ≥ªÁµ±...');
               
                console.log('üéµ ÈñãÂßãÊ∏¨Ë©¶Èü≥ÊïàÁ≥ªÁµ±...');
               
                // ÂàùÂßãÂåñÈü≥ÊïàÁ≥ªÁµ±
                const initSuccess = await AudioSystem.init();
                if (!initSuccess) {
                    throw new Error('Èü≥ÊïàÁ≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó');
                }
               
                AudioStatusManager.updateStatus('Ê≠£Âú®Ê∏¨Ë©¶Ë™ûÈü≥ÂêàÊàê...');
               
                // Ê∏¨Ë©¶‰∏âÂÄãÊèêÈÜíËÅ≤Êïà
                const testSequence = [
                    { minutes: 15, delay: 0 },
                    { minutes: 5, delay: 2000 },
                    { minutes: 0, delay: 4000 }
                ];
               
                for (const test of testSequence) {
                    setTimeout(async () => {
                        console.log(`Ê∏¨Ë©¶ ${test.minutes === 0 ? 'ËÄÉË©¶ÁµêÊùü' : test.minutes + 'ÂàÜÈêò'} ÊèêÈÜí`);
                        await AudioSystem.playExamAlert(test.minutes);
                    }, test.delay);
                }
               
                AudioStatusManager.updateStatus('‚úÖ Èü≥ÊïàÁ≥ªÁµ±Ê∏¨Ë©¶ÂÆåÊàêÔºÅ');
               
                // 3ÁßíÂæåÈáçÁΩÆÁãÄÊÖã
                setTimeout(() => {
                    AudioStatusManager.updateStatus('Èü≥ÊïàÁ≥ªÁµ±ÔºöÂ∑≤ÂàùÂßãÂåñ');
                }, 6000);
               
            } catch (error) {
                console.error('‚ùå Èü≥ÊïàÁ≥ªÁµ±Ê∏¨Ë©¶Â§±Êïó:', error);
                AudioStatusManager.updateStatus(`‚ùå Ê∏¨Ë©¶Â§±Êïó: ${error.message}`, true);
               
                // 3ÁßíÂæåÈáçÁΩÆÁãÄÊÖã
                setTimeout(() => {
                    AudioStatusManager.updateStatus('Èü≥ÊïàÁ≥ªÁµ±ÔºöÊ∏¨Ë©¶Â§±Êïó', true);
                }, 3000);
               
            } finally {
                // 3ÁßíÂæåÊÅ¢Âæ©ÊåâÈàï
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                }, 3000);
            }
        }
       
        function resetAllTimes() {
            // Clear all exam times
            Object.keys(AppState.examTimes).forEach(key => {
                AppState.examTimes[key] = '';
                document.getElementById(key).value = '';
            });
           
            AppState.alertHistory.clear();
            AppState.timeAlertHistory.clear();
           
            // Clear all timers
            AppState.timers.forEach(timer => clearInterval(timer));
            AppState.timers.clear();
           
            DisplayManager.updateDisplay();
        }

        // Application Initialization (Áç®Á´ãÁâàÊú¨)
        function initApp() {
            try {
                // Initialize dark mode
                DarkMode.init();
               
                // Initialize displays
                DisplayManager.updateDisplay();
               
                // Initialize audio system
                AudioSystem.init().then(success => {
                    if (success) {
                        AudioStatusManager.updateStatus('Èü≥ÊïàÁ≥ªÁµ±ÔºöÂ∑≤ÂàùÂßãÂåñ');
                        console.log('‚úÖ Èü≥ÊïàÁ≥ªÁµ±ÂàùÂßãÂåñÊàêÂäü');
                    } else {
                        AudioStatusManager.updateStatus('Èü≥ÊïàÁ≥ªÁµ±ÔºöÂàùÂßãÂåñÂ§±Êïó', true);
                        console.warn('‚ö†Ô∏è Èü≥ÊïàÁ≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåÂ∞á‰ΩøÁî®ÈôçÁ¥öÊ®°Âºè');
                    }
                }).catch(error => {
                    AudioStatusManager.updateStatus('Èü≥ÊïàÁ≥ªÁµ±ÔºöÂàùÂßãÂåñÂ§±Êïó', true);
                    console.error('‚ùå Èü≥ÊïàÁ≥ªÁµ±ÂàùÂßãÂåñÈåØË™§:', error);
                });
               
                // Start main update loop
                setInterval(() => {
                    DisplayManager.updateDisplay();
                    AlertChecker.checkTimeAlerts();
                }, 1000);
               
                // Add click outside modal to close
                document.getElementById('timePickerModal').addEventListener('click', function(event) {
                    if (event.target === this) {
                        TimePickerModal.close();
                    }
                });
               
                // Add keyboard support for time input displays
                document.querySelectorAll('.time-input-display').forEach(element => {
                    element.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            this.click();
                        }
                    });
                });
               
                console.log('‚úÖ ËÄÉË©¶Â†±ÊôÇÊèêÈÜíÁ≥ªÁµ±Â∑≤ÂàùÂßãÂåñ');
               
            } catch (error) {
                console.error('‚ùå ÊáâÁî®Á®ãÂºèÂàùÂßãÂåñÂ§±Êïó:', error);
            }
        }

        // Error Handling
        window.addEventListener('error', (event) => {
            console.error('JavaScriptÈåØË™§:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Êú™ËôïÁêÜÁöÑPromiseÊãíÁµï:', event.reason);
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Page Visibility API
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('ÊáâÁî®Á®ãÂºèÂ∑≤Êö´ÂÅú');
            } else {
                console.log('ÊáâÁî®Á®ãÂºèÂ∑≤ÊÅ¢Âæ©');
            }
        });
    </script>
</body>
</html>
