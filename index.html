<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="考試報時提醒系統 - 專業的考試時間管理工具">
    <meta name="keywords" content="考試, 報時, 提醒, 時間管理, 學校">
    <meta name="author" content="Examination Timing Alert System">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./images/favicon.png">
    
    <title>考試報時提醒系統</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- TailwindCSS Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E3A8A',
                        secondary: '#374151',
                        accent: '#D97706',
                        warning: '#D97706',
                        surface: '#F8FAFC',
                        'surface-dark': '#0F172A'
                    },
                    fontFamily: {
                        'mono': ['Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>
    
    <!-- Custom Styles -->
    <style>
        /* Animation Styles */
        .warning-flash {
            animation: flash 2s infinite;
        }
        
        @keyframes flash {
            0%, 50% { 
                background-color: #FEF3C7; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #F59E0B; 
                border-color: #92400E; 
            }
        }
        
        .dark .warning-flash {
            animation: flash-dark 2s infinite;
        }
        
        @keyframes flash-dark {
            0%, 50% { 
                background-color: #92400E; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #B45309; 
                border-color: #F59E0B; 
            }
        }
        
        .urgent-flash {
            animation: urgent 1s infinite;
        }
        
        @keyframes urgent {
            0%, 50% { 
                background-color: #FEF3C7; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #F59E0B; 
                border-color: #92400E; 
            }
        }
        
        .dark .urgent-flash {
            animation: urgent-dark 1s infinite;
        }
        
        @keyframes urgent-dark {
            0%, 50% { 
                background-color: #92400E; 
                border-color: #D97706; 
            }
            51%, 100% { 
                background-color: #B45309; 
                border-color: #F59E0B; 
            }
        }
        
        /* Enhanced Visual Effects */
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .time-display {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            min-height: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .dark .time-display {
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
        }
        
        /* Time Input Display */
        .time-input-display {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .time-input-display:hover {
            background-color: #F1F5F9;
            border-color: #1E3A8A;
        }
        
        .dark .time-input-display:hover {
            background-color: #475569;
            border-color: #3B82F6;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
        }
        
        .dark .modal-content {
            background: #1e293b;
            border: 1px solid #475569;
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1) translateY(0);
        }
        
        /* Time Picker Styles */
        .time-picker {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            margin: 1.5rem 0;
        }
        
        .time-input {
            width: 80px;
            height: 60px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            font-family: monospace;
            font-weight: bold;
        }
        
        .dark .time-input {
            background: #374151;
            border-color: #6b7280;
            color: white;
        }
        
        .time-input:focus {
            outline: none;
            border-color: #1E3A8A;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .time-separator {
            font-size: 2rem;
            font-weight: bold;
            color: #64748b;
        }
        
        .dark .time-separator {
            color: #94a3b8;
        }
        
        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
            
            .dark .warning-flash,
            .dark .urgent-flash {
                background-color: #92400E !important;
            }
            
            .modal-overlay,
            .modal-content {
                transition: none;
            }
        }
        
        /* Print Styles */
        @media print {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .modal-overlay {
                display: none !important;
            }
        }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 640px) {
            .time-display {
                font-size: 3rem !important;
            }
            
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .time-picker {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .time-input {
                width: 100px;
                height: 50px;
                font-size: 1.25rem;
            }
        }
        
        /* Focus Indicators */
        input:focus,
        button:focus {
            outline: 2px solid #1E3A8A;
            outline-offset: 2px;
        }
        
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen font-sans">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-white px-4 py-2 rounded">
        跳至主要內容
    </a>

    <!-- Header -->
    <header class="bg-primary dark:bg-slate-800 border-b-4 border-accent shadow-lg">
        <div class="container mx-auto p-6 max-w-7xl">
            <div class="flex items-center justify-center gap-6">
                <img 
                    src="./images/NDC_school_logov2.png" 
                    alt="學校校徽" 
                    class="h-16 w-16 object-contain"
                    loading="eager"
                    onerror="this.style.display='none'"
                >
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-white tracking-wider">
                        考試報時提醒系統
                    </h1>
                    <p class="text-blue-100 dark:text-slate-300 mt-2 text-lg">
                        EXAMINATION TIMING ALERT SYSTEM
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-6 max-w-7xl">
        <!-- Top Three Panels -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Subject Selection Panel -->
            <section aria-labelledby="subject-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-green-600 text-white p-4 border-b-2 border-green-700 rounded-t-lg">
                        <h2 id="subject-title" class="text-xl font-bold text-center tracking-wide">
                            考試科目
                        </h2>
                        <p class="text-center text-green-100 text-sm mt-1">
                            EXAM SUBJECT
                        </p>
                    </header>
                    
                    <div class="p-4">
                        <!-- Subject Selection 1 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">考試科目1 EXAM SUBJECT 1</div>
                                <select 
                                    id="examSubject1" 
                                    class="w-full py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-100 transition-all rounded focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 text-sm font-medium"
                                    onchange="updateExamSubject(1)"
                                    aria-label="選擇考試科目1"
                                >
                                    <option value="">請選擇考試科目1</option>
                                    <option value="中文科">中文科</option>
                                    <option value="英文科">英文科</option>
                                    <option value="數學科">數學科</option>
                                    <option value="公民與社會發展科">公民與社會發展科</option>
                                    <option value="生物科">生物科</option>
                                    <option value="化學科">化學科</option>
                                    <option value="物理科">物理科</option>
                                    <option value="資訊及通訊科技科">資訊及通訊科技科</option>
                                    <option value="企業、會計與財務概論科">企業、會計與財務概論科</option>
                                    <option value="經濟科">經濟科</option>
                                    <option value="地理科">地理科</option>
                                    <option value="中史科">中史科</option>
                                    <option value="歷史科">歷史科</option>
                                    <option value="視覺藝術科">視覺藝術科</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Subject Selection 2 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">考試科目2 EXAM SUBJECT 2</div>
                                <select 
                                    id="examSubject2" 
                                    class="w-full py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-slate-100 transition-all rounded focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-20 text-sm font-medium"
                                    onchange="updateExamSubject(2)"
                                    aria-label="選擇考試科目2"
                                >
                                    <option value="">請選擇考試科目2</option>
                                    <option value="中文科">中文科</option>
                                    <option value="英文科">英文科</option>
                                    <option value="數學科">數學科</option>
                                    <option value="公民與社會發展科">公民與社會發展科</option>
                                    <option value="生物科">生物科</option>
                                    <option value="化學科">化學科</option>
                                    <option value="物理科">物理科</option>
                                    <option value="資訊及通訊科技科">資訊及通訊科技科</option>
                                    <option value="企業、會計與財務概論科">企業、會計與財務概論科</option>
                                    <option value="經濟科">經濟科</option>
                                    <option value="地理科">地理科</option>
                                    <option value="中史科">中史科</option>
                                    <option value="歷史科">歷史科</option>
                                    <option value="視覺藝術科">視覺藝術科</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Time Configuration Panel -->
            <section aria-labelledby="config-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-green-600 text-white p-4 border-b-2 border-green-700 rounded-t-lg">
                        <h2 id="config-title" class="text-xl font-bold text-center tracking-wide">
                            考試時間設定
                        </h2>
                        <p class="text-center text-green-100 text-sm mt-1">
                            EXAM TIME CONFIGURATION
                        </p>
                    </header>
                    
                    <div class="p-4">
                        <!-- Time Configuration 1 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">考試科目1結束時間 SUBJECT 1 END TIME</div>
                                <div id="subject1EndDisplay" 
                                     class="py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display" 
                                     onclick="TimePickerModal.open('subject1End')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="設定考試科目1結束時間">
                                    <div class="text-sm font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Time Configuration 2 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">考試科目2結束時間 SUBJECT 2 END TIME</div>
                                <div id="subject2EndDisplay" 
                                     class="py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display" 
                                     onclick="TimePickerModal.open('subject2End')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="設定考試科目2結束時間">
                                    <div class="text-sm font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Time Display Panel -->
            <section aria-labelledby="remaining-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-green-600 text-white p-4 border-b-2 border-green-700 rounded-t-lg">
                        <h2 id="remaining-title" class="text-xl font-bold text-center tracking-wide">
                            剩餘時間
                        </h2>
                        <p class="text-center text-green-100 text-sm mt-1">
                            REMAINING TIME
                        </p>
                    </header>
                    
                    <div class="p-4">
                        <!-- Remaining Time Display 1 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">考試科目1剩餘時間 SUBJECT 1 REMAINING</div>
                                <div id="subject1Session" class="py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="subject1SessionTime" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Remaining Time Display 2 -->
                        <div class="mb-4">
                            <div class="mb-3">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">考試科目2剩餘時間 SUBJECT 2 REMAINING</div>
                                <div id="subject2Session" class="py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="subject2SessionTime" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
        
        <!-- Hong Kong Time Panel (Below the three panels) -->
        <div class="mb-8">
            <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                <header class="bg-primary text-white p-4 border-b-2 border-blue-800 rounded-t-lg">
                    <h2 class="text-xl font-bold text-center tracking-wide">香港標準時間</h2>
                    <p class="text-center text-blue-100 text-sm mt-1">HONG KONG STANDARD TIME</p>
                </header>
                <div class="p-8 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 rounded-b-lg">
                    <div class="text-center">
                        <time 
                            id="currentTime" 
                            class="text-6xl xl:text-7xl font-bold font-mono text-primary dark:text-blue-300 time-display tracking-wider mb-4 block"
                            role="timer"
                            aria-live="polite"
                        ></time>
                        <div id="currentDate" class="text-lg text-slate-600 dark:text-slate-400 font-medium"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Buttons Section -->
        <div class="mt-8 text-center space-y-4">
            <!-- Audio Test Button -->
            <div>
                <button 
                    onclick="testAudioSystem()" 
                    class="bg-accent hover:bg-yellow-600 text-white py-3 px-8 font-semibold tracking-wide uppercase transition-colors border-2 border-accent hover:border-yellow-600 rounded-lg shadow-lg hover:shadow-xl focus:ring-2 focus:ring-offset-2 focus:ring-accent mr-4"
                    aria-describedby="audio-test-desc"
                >
                    🎵 測試音效系統 TEST AUDIO
                </button>
                <span id="audio-test-desc" class="sr-only">測試音效播放功能</span>
                
                <!-- Audio Status Indicator -->
                <div id="audioStatus" class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                    <span id="audioStatusText">音效系統：未初始化</span>
                </div>
            </div>
            
            <!-- Reset Button -->
            <div>
                <button 
                    onclick="resetAllTimes()" 
                    class="bg-secondary hover:bg-slate-600 text-white py-3 px-8 font-semibold tracking-wide uppercase transition-colors border-2 border-secondary hover:border-slate-600 rounded-lg shadow-lg hover:shadow-xl focus:ring-2 focus:ring-offset-2 focus:ring-secondary"
                    aria-describedby="reset-desc"
                >
                    重置所有設定 RESET ALL
                </button>
                <span id="reset-desc" class="sr-only">清除所有時間設定</span>
            </div>
        </div>
    </main>

    <!-- Time Picker Modal -->
    <div id="timePickerModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-center mb-4 text-slate-900 dark:text-slate-100">設定考試結束時間</h3>
            
            <div class="time-picker">
                <div>
                    <label for="hourInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center">小時</label>
                    <input type="number" id="hourInput" class="time-input" min="0" max="23" placeholder="HH">
                </div>
                
                <div class="time-separator">:</div>
                
                <div>
                    <label for="minuteInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center">分鐘</label>
                    <input type="number" id="minuteInput" class="time-input" min="0" max="59" placeholder="MM">
                </div>
            </div>
            
            <div class="flex gap-3 justify-center mt-6">
                <button onclick="TimePickerModal.save()" class="bg-primary hover:bg-blue-800 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    確定
                </button>
                <button onclick="TimePickerModal.clear()" class="bg-warning hover:bg-yellow-600 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-warning">
                    清除
                </button>
                <button onclick="TimePickerModal.close()" class="bg-slate-500 hover:bg-slate-600 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden input fields for backwards compatibility -->
    <div style="display: none;">
        <input type="time" id="subject1End">
        <input type="time" id="subject2End">
    </div>

    <!-- JavaScript Application -->
    <script>
        'use strict';
        
        // Application State
        const AppState = {
            alertHistory: new Set(),
            timeAlertHistory: new Set(),
            isPlayingAudio: false,
            timers: new Map(),
            examTimes: {
                subject1End: '',
                subject2End: ''
            },
            examSubject1: '',
            examSubject2: ''
        };

        // Time Picker Modal
        const TimePickerModal = {
            currentField: null,
            
            open(fieldId) {
                this.currentField = fieldId;
                const modal = document.getElementById('timePickerModal');
                const hourInput = document.getElementById('hourInput');
                const minuteInput = document.getElementById('minuteInput');
                
                // Get current time value
                const currentTime = AppState.examTimes[fieldId];
                if (currentTime) {
                    const [hours, minutes] = currentTime.split(':');
                    hourInput.value = parseInt(hours).toString();
                    minuteInput.value = parseInt(minutes).toString();
                } else {
                    hourInput.value = '';
                    minuteInput.value = '';
                }
                
                modal.classList.add('show');
                
                // Focus first input
                setTimeout(() => {
                    hourInput.focus();
                }, 100);
                
                // Add keyboard listeners
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
            },
            
            close() {
                const modal = document.getElementById('timePickerModal');
                modal.classList.remove('show');
                this.currentField = null;
                
                // Remove keyboard listeners
                document.removeEventListener('keydown', this.handleKeyDown.bind(this));
            },
            
            async save() {
                const hourInput = document.getElementById('hourInput');
                const minuteInput = document.getElementById('minuteInput');
                
                let hours = parseInt(hourInput.value) || 0;
                let minutes = parseInt(minuteInput.value) || 0;
                
                // Validate input
                if (hours < 0 || hours > 23) {
                    this.showValidationMessage('小時必須在 0-23 之間');
                    hourInput.focus();
                    return;
                }
                
                if (minutes < 0 || minutes > 59) {
                    this.showValidationMessage('分鐘必須在 0-59 之間');
                    minuteInput.focus();
                    return;
                }
                
                // Format time
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                

                
                // Update state and display
                AppState.examTimes[this.currentField] = timeString;
                
                // 安全地設置隱藏input的值
                const hiddenInput = document.getElementById(this.currentField);
                if (hiddenInput) {
                    hiddenInput.value = timeString;
                }
                
                this.updateDisplay(this.currentField);
                
                // Clear alert histories when time is changed
                AppState.alertHistory.clear();
                AppState.timeAlertHistory.clear();
                

                
                this.close();
                
                // Update main display
                DisplayManager.updateDisplay();
            },
            
            clear() {
                AppState.examTimes[this.currentField] = '';
                
                // 安全地清除隱藏input的值
                const hiddenInput = document.getElementById(this.currentField);
                if (hiddenInput) {
                    hiddenInput.value = '';
                }
                
                this.updateDisplay(this.currentField);
                
                // Clear alert histories
                AppState.alertHistory.clear();
                AppState.timeAlertHistory.clear();
                
                this.close();
                
                // Update main display
                DisplayManager.updateDisplay();
            },
            
            updateDisplay(fieldId) {
                const displayElement = document.getElementById(fieldId + 'Display');
                if (!displayElement) {
                    console.warn(`顯示元素不存在: ${fieldId}Display`);
                    return;
                }
                
                const timeDiv = displayElement.querySelector('.time-display');
                if (!timeDiv) {
                    console.warn(`時間顯示元素不存在: .time-display in ${fieldId}Display`);
                    return;
                }
                
                const timeValue = AppState.examTimes[fieldId];
                
                if (timeValue) {
                    timeDiv.textContent = timeValue;
                } else {
                    timeDiv.textContent = '--:--';
                }
            },
            
            showValidationMessage(message) {
                // Create custom validation message
                const modal = document.querySelector('.modal-content');
                
                // Remove existing validation message
                const existingMessage = modal.querySelector('.validation-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Create new validation message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'validation-message bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded mb-4';
                messageDiv.textContent = message;
                
                // Insert before time picker
                const timePicker = modal.querySelector('.time-picker');
                modal.insertBefore(messageDiv, timePicker);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 3000);
            },
            
            handleKeyDown(event) {
                if (event.key === 'Escape') {
                    this.close();
                } else if (event.key === 'Enter') {
                    this.save();
                }
            }
        };

        // Utility Functions
        const Utils = {
            formatTime(date) {
                return date.toLocaleTimeString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            formatDate(date) {
                return date.toLocaleDateString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            },

            getHongKongTime() {
                return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Dark Mode Manager
        const DarkMode = {
            init() {
                // Initial check
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                
                // Listen for changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
        };

        // Time Calculator
        const TimeCalculator = {
            calculateTimeRemaining(endTime) {
                if (!endTime) return null;
                
                const now = Utils.getHongKongTime();
                const [hours, minutes] = endTime.split(':');
                const examEnd = new Date(now);
                examEnd.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                if (examEnd < now) {
                    examEnd.setDate(examEnd.getDate() + 1);
                }
                
                const diff = examEnd - now;
                
                if (diff <= 0) {
                    console.log(`⏰ 考試時間已到: endTime=${endTime}, diff=${diff}ms`);
                    return { ended: true, text: '考試已結束' };
                }
                
                const totalSeconds = Math.floor(diff / 1000);
                const hours_remaining = Math.floor(totalSeconds / 3600);
                const minutes_remaining = Math.floor((totalSeconds % 3600) / 60);
                const seconds_remaining = totalSeconds % 60;
                
                return {
                    ended: false,
                    totalSeconds,
                    hours: hours_remaining,
                    minutes: minutes_remaining,
                    seconds: seconds_remaining,
                    text: `${hours_remaining.toString().padStart(2, '0')}:${minutes_remaining.toString().padStart(2, '0')}:${seconds_remaining.toString().padStart(2, '0')}`
                };
            }
        };









        // Audio System (獨立版本 - 不依賴 Poe API)
        const AudioSystem = {
            audioContext: null,
            isInitialized: false,
            speechSynthesis: window.speechSynthesis,
            voices: [],
            isPlaying: false,
            speechQueue: [],

            // 初始化音效系統
            async init() {
                if (this.isInitialized) return true;

                try {
                    // 初始化 Web Audio API
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    // 初始化語音合成
                    this.initSpeechSynthesis();
                    
                    console.log('✅ 音效系統初始化成功');
                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('❌ 音效系統初始化失敗:', error);
                    return false;
                }
            },

            // 初始化語音合成
            initSpeechSynthesis() {
                if (!this.speechSynthesis) {
                    console.warn('⚠️ 瀏覽器不支援語音合成');
                    return false;
                }

                // 載入可用語音
                this.voices = this.speechSynthesis.getVoices();
                
                // 如果語音列表為空，等待語音載入
                if (this.voices.length === 0) {
                    this.speechSynthesis.addEventListener('voiceschanged', () => {
                        this.voices = this.speechSynthesis.getVoices();
                        console.log(`✅ 載入 ${this.voices.length} 個語音`);
                    });
                }

                return true;
            },

            // 選擇最佳中文語音
            getBestChineseVoice() {
                if (!this.voices.length) {
                    this.voices = this.speechSynthesis.getVoices();
                }

                // 優先順序：香港粵語 > 台灣中文 > 大陸中文 > 其他中文
                const priorities = [
                    /zh-HK|yue/i,    // 香港粵語
                    /zh-TW/i,        // 台灣中文
                    /zh-CN/i,        // 大陸中文
                    /zh/i            // 其他中文
                ];

                for (const pattern of priorities) {
                    const voice = this.voices.find(v => pattern.test(v.lang));
                    if (voice) return voice;
                }

                // 如果沒有中文語音，返回預設語音
                return this.voices[0] || null;
            },

            // 播放多個考試提醒（合併播放避免重疊）
            async playMultipleAlerts(alerts) {
                if (alerts.length === 0) return;
                
                // 按分鐘數分組
                const groupedByMinutes = {};
                alerts.forEach(alert => {
                    if (!groupedByMinutes[alert.minutes]) {
                        groupedByMinutes[alert.minutes] = [];
                    }
                    groupedByMinutes[alert.minutes].push(alert);
                });
                
                // 為每個時間點生成合併的提醒文字，按優先級排序
                // 優先級：1. 考試結束(0分鐘) 2. 最後5分鐘 3. 最後15分鐘
                const messages = [];
                const priorityOrder = [0, 5, 15]; // 按重要性排序
                
                priorityOrder.forEach(minutes => {
                    if (groupedByMinutes[minutes]) {
                        const alertsForMinutes = groupedByMinutes[minutes];
                        const text = this.generateCombinedAlertText(minutes, alertsForMinutes);
                        if (text) {
                            messages.push(text);
                        }
                    }
                });
                
                // 按優先級分別播放提醒（而不是合併成一個）
                if (messages.length > 0) {
                    console.log(`🔊 按優先級播放 ${messages.length} 個提醒: [${messages.join(', ')}]`);
                    for (const message of messages) {
                        console.log(`📢 添加到語音隊列: "${message}"`);
                        await this.queueSpeech(message);
                    }
                } else {
                    console.warn('⚠️ 沒有生成任何提醒訊息');
                }
            },
            
            // 生成合併的提醒文字
            generateCombinedAlertText(minutes, alerts) {
                if (alerts.length === 0) {
                    console.warn(`⚠️ generateCombinedAlertText: 沒有提醒數據 (minutes=${minutes})`);
                    return '';
                }
                
                // 獲取科目名稱
                const subjectNames = alerts.map(alert => {
                    return alert.subjectName || `考試科目${alert.subjectNumber}`;
                }).filter(name => name);
                
                let subjectText = '';
                if (subjectNames.length === 1) {
                    subjectText = subjectNames[0];
                } else if (subjectNames.length === 2) {
                    subjectText = `${subjectNames[0]}及${subjectNames[1]}`;
                } else {
                    subjectText = '多個考試科目';
                }
                
                let message = '';
                switch(minutes) {
                    case 15:
                        message = `${subjectText}考試時間尚餘15分鐘`;
                        break;
                    case 5:
                        message = `${subjectText}考試時間尚餘5分鐘`;
                        break;
                    case 0:
                        message = `${subjectText}考試結束，請停筆`;
                        break;
                    default:
                        console.warn(`⚠️ 未知的分鐘數: ${minutes}`);
                        return '';
                }
                
                console.log(`🔊 生成提醒文字 (${minutes}分鐘): "${message}"`);
                return message;
            },

            // 語音隊列管理系統
            async queueSpeech(text) {
                return new Promise((resolve) => {
                    // 添加到隊列
                    this.speechQueue.push({ text, resolve });
                    
                    // 如果當前沒有播放，開始處理隊列
                    if (!this.isPlaying) {
                        this.processSpeechQueue();
                    }
                });
            },
            
            // 處理語音隊列
            async processSpeechQueue() {
                if (this.speechQueue.length === 0 || this.isPlaying) {
                    return;
                }
                
                this.isPlaying = true;
                
                while (this.speechQueue.length > 0) {
                    const { text, resolve } = this.speechQueue.shift();
                    
                    try {
                        console.log(`🔊 隊列播放: ${text}`);
                        await this.playBeepAndSpeechSync(text);
                        resolve();
                    } catch (error) {
                        console.error('語音播放失敗:', error);
                        this.showVisualAlert(text);
                        resolve();
                    }
                    
                    // 在語音之間添加短暫間隔
                    if (this.speechQueue.length > 0) {
                        await this.delay(500);
                    }
                }
                
                this.isPlaying = false;
            },
            
            // 延遲函數
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            // 播放考試提醒聲效（保留向下兼容）
            async playExamAlert(minutes, subjectNumber = null) {
                let text;
                let subjectText = '';
                
                if (subjectNumber === 1) {
                    // 科目1的提醒
                    subjectText = AppState.examSubject1 || '考試科目1';
                } else if (subjectNumber === 2) {
                    // 科目2的提醒
                    subjectText = AppState.examSubject2 || '考試科目2';
                } else {
                    // 通用提醒（向下兼容）
                    const subject1 = AppState.examSubject1;
                    const subject2 = AppState.examSubject2;
                    if (subject1 && subject2) {
                        subjectText = `${subject1}及${subject2}`;
                    } else if (subject1) {
                        subjectText = subject1;
                    } else if (subject2) {
                        subjectText = subject2;
                    }
                }
                
                switch(minutes) {
                    case 15:
                        text = subjectText ? `${subjectText}考試時間尚餘15分鐘` : '考試時間尚餘15分鐘';
                        break;
                    case 5:
                        text = subjectText ? `${subjectText}考試時間尚餘5分鐘` : '考試時間尚餘5分鐘';
                        break;
                    case 0:
                        text = subjectText ? `${subjectText}考試結束，請停筆` : '考試結束，請停筆';
                        break;
                    default:
                        console.warn(`未知的分鐘數: ${minutes}`);
                        return;
                }
                
                console.log(`🔊 播放提醒: ${text}`);
                
                // 使用隊列系統播放
                await this.queueSpeech(text);
            },

            // 播放提示音和語音（同步版本，用於隊列）
            async playBeepAndSpeechSync(text) {
                try {
                    // 先播放提示音
                    await this.playBeep();
                    
                    // 等待300ms後播放語音
                    await this.delay(300);
                    
                    // 播放語音並等待完成
                    await this.speakTextSync(text);
                    
                } catch (error) {
                    console.error('播放音效失敗:', error);
                    // 降級：只顯示視覺提醒
                    this.showVisualAlert(text);
                }
            },
            
            // 播放提示音和語音（舊版本，保持向下兼容）
            async playBeepAndSpeech(text) {
                try {
                    // 先播放提示音
                    await this.playBeep();
                    
                    // 稍作延遲後播放語音
                    setTimeout(() => {
                        this.speakText(text);
                    }, 300);
                    
                } catch (error) {
                    console.error('播放音效失敗:', error);
                    // 降級：只顯示視覺提醒
                    this.showVisualAlert(text);
                }
            },

            // 播放提示音（使用 Web Audio API）
            async playBeep() {
                if (!this.audioContext) return;

                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // 設置提示音參數
                    oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.5);
                    
                } catch (error) {
                    console.error('播放提示音失敗:', error);
                }
            },

            // 語音合成（同步版本，返回Promise）
            speakTextSync(text) {
                return new Promise((resolve, reject) => {
                    if (!this.speechSynthesis) {
                        console.warn('語音合成不可用');
                        resolve();
                        return;
                    }

                    // 停止當前語音
                    this.speechSynthesis.cancel();

                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // 設置語音參數
                    const voice = this.getBestChineseVoice();
                    if (voice) {
                        utterance.voice = voice;
                    }
                    
                    utterance.rate = 0.9;     // 稍慢的語速
                    utterance.pitch = 1.0;    // 正常音調
                    utterance.volume = 0.8;   // 音量

                    // 事件處理
                    utterance.onstart = () => {
                        console.log('🗣️ 開始語音播放');
                    };
                    
                    utterance.onend = () => {
                        console.log('✅ 語音播放完成');
                        resolve();
                    };
                    
                    utterance.onerror = (event) => {
                        console.error('❌ 語音播放失敗:', event.error);
                        reject(event.error);
                    };

                    this.speechSynthesis.speak(utterance);
                });
            },
            
            // 語音合成（舊版本，保持向下兼容）
            speakText(text) {
                if (!this.speechSynthesis) {
                    console.warn('語音合成不可用');
                    return;
                }

                // 停止當前語音
                this.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                
                // 設置語音參數
                const voice = this.getBestChineseVoice();
                if (voice) {
                    utterance.voice = voice;
                }
                
                utterance.rate = 0.9;     // 稍慢的語速
                utterance.pitch = 1.0;    // 正常音調
                utterance.volume = 0.8;   // 音量

                // 事件處理
                utterance.onstart = () => {
                    console.log('🗣️ 開始語音播放');
                };
                
                utterance.onend = () => {
                    console.log('✅ 語音播放完成');
                };
                
                utterance.onerror = (event) => {
                    console.error('❌ 語音播放失敗:', event.error);
                };

                this.speechSynthesis.speak(utterance);
            },

            // 視覺提醒（降級方案）
            showVisualAlert(text) {
                console.log('📢 顯示視覺提醒:', text);
                
                // 創建提醒彈窗
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-4 rounded-lg shadow-xl z-50 font-bold text-lg animate-pulse';
                alertDiv.textContent = text;
                
                document.body.appendChild(alertDiv);
                
                // 3秒後自動移除
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        };

        // Alert Checker
        const AlertChecker = {
            checkTimeAlerts() {
                const currentAlerts = []; // 收集當前時刻的所有提醒
                
                // 檢查兩個科目的時間提醒
                ['subject1End', 'subject2End'].forEach(examKey => {
                    const endTime = AppState.examTimes[examKey];
                    const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                    
                    if (!timeRemaining) return;
                    
                    const specificMinutes = [15, 5, 0]; // 檢查15分鐘、5分鐘和考試結束
                    const subjectNumber = examKey === 'subject1End' ? 1 : 2;
                    
                    specificMinutes.forEach(targetMinutes => {
                        let shouldTrigger = false;
                        
                        if (targetMinutes === 0) {
                            // 考試結束檢查 - 當時間到達或已過期時觸發
                            shouldTrigger = timeRemaining.ended;
                            console.log(`🔍 檢查科目${subjectNumber}考試結束: ended=${timeRemaining.ended}, shouldTrigger=${shouldTrigger}`);
                        } else {
                            // 15分鐘和5分鐘檢查 - 只在考試未結束時檢查
                            if (!timeRemaining.ended) {
                                const totalMinutes = Math.floor(timeRemaining.totalSeconds / 60);
                                const seconds = timeRemaining.totalSeconds % 60;
                                shouldTrigger = (totalMinutes === targetMinutes && seconds <= 2);
                                if (shouldTrigger) {
                                    console.log(`🔍 檢查科目${subjectNumber} ${targetMinutes}分鐘提醒: totalMinutes=${totalMinutes}, seconds=${seconds}`);
                                }
                            }
                        }
                        
                        if (shouldTrigger) {
                            const timeAlertKey = `${examKey}-${targetMinutes}mins`;
                            
                            if (!AppState.timeAlertHistory.has(timeAlertKey)) {
                                AppState.timeAlertHistory.add(timeAlertKey);
                                
                                console.log(`🔔 觸發科目${subjectNumber}時間提醒: ${targetMinutes === 0 ? '考試結束' : targetMinutes + '分鐘'}`);
                                
                                // 收集提醒而不是立即播放
                                currentAlerts.push({
                                    minutes: targetMinutes,
                                    subjectNumber: subjectNumber,
                                    subjectName: subjectNumber === 1 ? AppState.examSubject1 : AppState.examSubject2
                                });
                            }
                        }
                    });
                });
                
                // 如果有提醒需要播放，合併播放
                if (currentAlerts.length > 0) {
                    AudioSystem.playMultipleAlerts(currentAlerts);
                }
            }
        };

        // Display Manager
        const DisplayManager = {
            updateDisplay() {
                const now = Utils.getHongKongTime();
                document.getElementById('currentTime').textContent = Utils.formatTime(now);
                document.getElementById('currentDate').textContent = Utils.formatDate(now);
                
                // Update exam countdown displays for both subjects
                ['subject1End', 'subject2End'].forEach(examKey => {
                    const endTime = AppState.examTimes[examKey];
                    const subjectNumber = examKey === 'subject1End' ? '1' : '2';
                    const timeDisplay = document.getElementById(`subject${subjectNumber}SessionTime`);
                    const container = document.getElementById(`subject${subjectNumber}Session`);
                    
                    if (!timeDisplay || !container) return;
                    
                    const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                    
                    if (!endTime) {
                        timeDisplay.textContent = '--:--:--';
                        container.className = 'py-2 px-3 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded';
                    } else if (timeRemaining.ended) {
                        timeDisplay.textContent = timeRemaining.text;
                        container.className = 'py-2 px-3 border-2 border-accent bg-yellow-100 dark:bg-yellow-900 transition-all rounded';
                    } else {
                        timeDisplay.textContent = timeRemaining.text;
                        
                        let className = 'py-2 px-3 border-2 transition-all rounded ';
                        if (timeRemaining.totalSeconds <= 30) {
                            className += 'urgent-flash border-accent';
                        } else if (timeRemaining.totalSeconds <= 330) {
                            className += 'warning-flash border-warning';
                        } else if (timeRemaining.totalSeconds <= 930) {
                            className += 'warning-flash border-warning';
                        } else {
                            className += 'border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700';
                        }
                        container.className = className;
                    }
                });
                
                // Update time input displays
                Object.keys(AppState.examTimes).forEach(fieldId => {
                    TimePickerModal.updateDisplay(fieldId);
                });
            }
        };



        // Audio Status Manager
        const AudioStatusManager = {
            updateStatus(message, isError = false) {
                const statusElement = document.getElementById('audioStatusText');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = isError ? 'text-red-600 dark:text-red-400' : 'text-slate-600 dark:text-slate-400';
                }
            }
        };

        // Global Functions
        
        // Test Audio System Function (獨立版本)
        async function testAudioSystem() {
            const button = event.target;
            const originalText = button.textContent;
            
            try {
                button.disabled = true;
                button.textContent = '🎵 測試中...';
                AudioStatusManager.updateStatus('正在測試音效系統...');
                
                console.log('🎵 開始測試音效系統...');
                
                // 初始化音效系統
                const initSuccess = await AudioSystem.init();
                if (!initSuccess) {
                    throw new Error('音效系統初始化失敗');
                }
                
                AudioStatusManager.updateStatus('正在測試語音合成...');
                
                // 設置臨時測試科目
                const originalSubject1 = AppState.examSubject1;
                const originalSubject2 = AppState.examSubject2;
                AppState.examSubject1 = '數學科'; // 使用數學科作為測試
                AppState.examSubject2 = '英文科';
                
                // 測試兩個科目的提醒聲效（包括同時播放測試）
                const testSequence = [
                    // 單獨提醒測試
                    { type: 'single', minutes: 15, subjectNumber: 1, delay: 0 },
                    { type: 'single', minutes: 5, subjectNumber: 2, delay: 2000 },
                    // 同時提醒測試（模擬兩科目同時結束）
                    { type: 'multiple', delay: 4000 }
                ];
                
                for (const test of testSequence) {
                    setTimeout(async () => {
                        if (test.type === 'single') {
                            console.log(`測試科目${test.subjectNumber} ${test.minutes === 0 ? '考試結束' : test.minutes + '分鐘'} 提醒`);
                            await AudioSystem.playExamAlert(test.minutes, test.subjectNumber);
                        } else if (test.type === 'multiple') {
                            console.log('測試優先級排序：結束 + 5分鐘 + 15分鐘提醒');
                            const multipleAlerts = [
                                { minutes: 0, subjectNumber: 1, subjectName: AppState.examSubject1 },   // 考試結束 (最高優先級)
                                { minutes: 5, subjectNumber: 2, subjectName: AppState.examSubject2 },   // 5分鐘提醒
                                { minutes: 15, subjectNumber: 1, subjectName: AppState.examSubject1 }   // 15分鐘提醒
                            ];
                            console.log('🎵 直接測試多重提醒，確保考試結束提醒包含在內');
                            await AudioSystem.playMultipleAlerts(multipleAlerts);
                        }
                    }, test.delay);
                }
                
                // 7秒後恢復原始科目
                setTimeout(() => {
                    AppState.examSubject1 = originalSubject1;
                    AppState.examSubject2 = originalSubject2;
                }, 7000);
                
                AudioStatusManager.updateStatus('✅ 音效系統測試完成！');
                
                // 3秒後重置狀態
                setTimeout(() => {
                    AudioStatusManager.updateStatus('音效系統：已初始化');
                }, 6000);
                
            } catch (error) {
                console.error('❌ 音效系統測試失敗:', error);
                AudioStatusManager.updateStatus(`❌ 測試失敗: ${error.message}`, true);
                
                // 3秒後重置狀態
                setTimeout(() => {
                    AudioStatusManager.updateStatus('音效系統：測試失敗', true);
                }, 3000);
                
            } finally {
                // 3秒後恢復按鈕
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                }, 3000);
            }
        }
        
        // Subject Management
        function updateExamSubject(subjectNumber) {
            const subjectSelect = document.getElementById(`examSubject${subjectNumber}`);
            
            if (subjectNumber === 1) {
                AppState.examSubject1 = subjectSelect.value;
                console.log(`📚 考試科目1已更新: ${AppState.examSubject1 || '未選擇'}`);
            } else if (subjectNumber === 2) {
                AppState.examSubject2 = subjectSelect.value;
                console.log(`📚 考試科目2已更新: ${AppState.examSubject2 || '未選擇'}`);
            }
            
            // Clear alert histories when subject is changed
            AppState.alertHistory.clear();
            AppState.timeAlertHistory.clear();
        }

        function resetAllTimes() {
            // Clear all exam times
            Object.keys(AppState.examTimes).forEach(key => {
                AppState.examTimes[key] = '';
                const input = document.getElementById(key);
                if (input) input.value = '';
            });
            
            // Clear exam subjects
            AppState.examSubject1 = '';
            AppState.examSubject2 = '';
            const subjectSelect1 = document.getElementById('examSubject1');
            const subjectSelect2 = document.getElementById('examSubject2');
            if (subjectSelect1) subjectSelect1.value = '';
            if (subjectSelect2) subjectSelect2.value = '';
            updateExamSubject(1);
            updateExamSubject(2);
            
            AppState.alertHistory.clear();
            AppState.timeAlertHistory.clear();
            
            // Clear all timers
            AppState.timers.forEach(timer => clearInterval(timer));
            AppState.timers.clear();
            
            DisplayManager.updateDisplay();
        }

        // Application Initialization (獨立版本)
        function initApp() {
            try {
                // Initialize dark mode
                DarkMode.init();
                
                // Initialize displays
                DisplayManager.updateDisplay();
                updateExamSubject(1);
                updateExamSubject(2);
                
                // Initialize audio system
                AudioSystem.init().then(success => {
                    if (success) {
                        AudioStatusManager.updateStatus('音效系統：已初始化');
                        console.log('✅ 音效系統初始化成功');
                    } else {
                        AudioStatusManager.updateStatus('音效系統：初始化失敗', true);
                        console.warn('⚠️ 音效系統初始化失敗，將使用降級模式');
                    }
                }).catch(error => {
                    AudioStatusManager.updateStatus('音效系統：初始化失敗', true);
                    console.error('❌ 音效系統初始化錯誤:', error);
                });
                
                // Start main update loop
                setInterval(() => {
                    DisplayManager.updateDisplay();
                    AlertChecker.checkTimeAlerts();
                }, 1000);
                
                // Add click outside modal to close
                document.getElementById('timePickerModal').addEventListener('click', function(event) {
                    if (event.target === this) {
                        TimePickerModal.close();
                    }
                });
                
                // Add keyboard support for time input displays
                document.querySelectorAll('.time-input-display').forEach(element => {
                    element.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            this.click();
                        }
                    });
                });
                
                console.log('✅ 考試報時提醒系統已初始化');
                
            } catch (error) {
                console.error('❌ 應用程式初始化失敗:', error);
            }
        }

        // Error Handling
        window.addEventListener('error', (event) => {
            console.error('JavaScript錯誤:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('未處理的Promise拒絕:', event.reason);
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Page Visibility API
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('應用程式已暫停');
            } else {
                console.log('應用程式已恢復');
            }
        });
    </script>
</body>
</html>
